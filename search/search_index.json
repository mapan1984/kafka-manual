{"config":{"lang":["en","ja"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"kafka \u4f7f\u7528\u624b\u518c","text":""},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/","title":"kafka \u57fa\u7840\u64cd\u4f5c","text":""},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#_1","title":"\u9884\u8bbe\u73af\u5883\u53d8\u91cf","text":"<p>\u9884\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\uff0c\u65b9\u4fbf\u64cd\u4f5c\uff1a</p> <pre><code># \u5c06 kafka \u547d\u4ee4\u811a\u672c\u8def\u5f84\u52a0\u5165\u5230 PATH\nexport KAFKA_HOME=/usr/local/kafka\nexport PATH=\"$PATH:${KAFKA_HOME}/bin\"\n\n# zk \u8fde\u63a5\u5730\u5740\nexport ZK_CONNECT=\"$(hostname):2181\"\n\n# kafka \u8fde\u63a5\u5730\u5740\nexport BOOTSTRAP_SERVER=\"$(hostname):9092\"\n\n# \u5982\u679c\u6709 jaas \u8ba4\u8bc1\nexport KAFKA_OPTS=\"-Djava.security.auth.login.config=${KAFKA_HOME}/config/kafka_server_jaas.conf\"\n\n# \u5982\u679c broker \u901a\u8fc7\u5728 kafka-run-class.sh \u6587\u4ef6\u5185\u8bbe\u7f6e JMX_PORT\uff0c\u5219\u8fd9\u91cc\u9700\u8981\u8bbe\u7f6e\u6210\u4e0d\u540c\u7684 port\n# (\u4e00\u822c broker \u5f00\u542f JMX_PORT \u6700\u597d\u5728 kafka-server-start.sh \u6587\u4ef6\u5185\u8bbe\u7f6e\uff0ckafka-run-class.sh \u6587\u4ef6\u5185\u7684\u4fee\u6539\u4f1a\u5f71\u54cd\u5230\u6240\u6709\u547d\u4ee4\u811a\u672c)\n# export JMX_PORT=9997\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#_2","title":"\u57fa\u672c\u64cd\u4f5c","text":""},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#topic","title":"topic","text":"<p>\u521b\u5efa topic</p> <pre><code>kafka-topics.sh --zookeeper ${ZK_CONNECT} --create --replication-factor 3 --partitions 3 --topic __test\n\nkafka-topics.sh --bootstrap-server ${BOOTSTRAP_SERVER} --create --replication-factor 3 --partitions 3 --topic __test\n</code></pre> <p>\u5220\u9664 topic</p> <pre><code>kafka-topics.sh --zookeeper ${ZK_CONNECT} --delete --topic __test\n\nkafka-topics.sh --bootstrap-server ${BOOTSTRAP_SERVER} --delete --topic __test\n</code></pre> <p>topic \u5217\u8868</p> <pre><code>kafka-topics.sh --zookeeper ${ZK_CONNECT} --list\n\nkafka-topics.sh --bootstrap-server ${BOOTSTRAP_SERVER} --list\n</code></pre> <p>topic \u8be6\u60c5</p> <pre><code>kafka-topics.sh --zookeeper ${ZK_CONNECT} --describe --topic test\n\nkafka-topics.sh --bootstrap-server ${BOOTSTRAP_SERVER} --describe --topic __test\n</code></pre> <p>\u4fee\u6539 topic \u5206\u533a\u6570</p> <pre><code>kafka-topics.sh --zookeeper ${ZK_CONNECT} --alter --topic __test --partitions 5\n\nkafka-topics.sh --bootstrap-server ${BOOTSTRAP_SERVER} --alter --topic __test --partitions 5\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#_3","title":"\u751f\u4ea7/\u6d88\u8d39","text":"<p>\u751f\u4ea7 \u6d88\u606f</p> <pre><code>kafka-console-producer.sh --broker-list ${BOOTSTRAP_SERVER} --topic __test\n\nkafka-console-producer.sh --bootstrap-server ${BOOTSTRAP_SERVER} --topic __test\n</code></pre> <p>\u6d88\u8d39 \u6d88\u606f</p> <pre><code>kafka-console-consumer.sh --bootstrap-server ${BOOTSTRAP_SERVER} --topic __test --from-beginning\n\nkafka-console-consumer.sh --property print.timestamp=true --property print.key=true \\\n    --bootstrap-server ${BOOTSTRAP_SERVER} --group test_group --topic test --from-beginning\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#consumer","title":"consumer","text":"<p>consumer \u5217\u8868</p> <pre><code># \u8bb0\u5f55\u5728 zookeeper \u4e2d\u7684\u6d88\u8d39\u7ec4\uff082.x.x \u7248\u672c\u4ee5\u4e0a\u5e9f\u5f03\uff09\nkafka-consumer-groups.sh --zookeeper ${ZK_CONNECT} --list\n\n# \u8bb0\u5f55\u5728 __consumer_offsets \u4e2d\u7684\u6d88\u8d39\u7ec4\uff0cKafka \u7248\u672c &lt;= 0.9.x.x\nkafka-consumer-groups.sh --bootstrap-server ${BOOTSTRAP_SERVER} --list --new-consumer\n\n# \u8bb0\u5f55\u5728 __consumer_offsets \u4e2d\u7684\u6d88\u8d39\u7ec4\uff0cKafka \u7248\u672c &gt; 0.9.x.x\nkafka-consumer-groups.sh --bootstrap-server ${BOOTSTRAP_SERVER} --list\n</code></pre> <p>consumer \u8be6\u60c5</p> <pre><code># \u8bb0\u5f55\u5728 zookeeper \u4e2d\u7684\u6d88\u8d39\u7ec4\uff082.x.x \u7248\u672c\u4ee5\u4e0a\u5e9f\u5f03\uff09\nkafka-consumer-groups.sh --zookeeper ${ZK_CONNECT} --describe --group $group\n\n# \u8bb0\u5f55\u5728 __consumer_offsets \u4e2d\u7684\u6d88\u8d39\u7ec4\uff0cKafka \u7248\u672c &lt;= 0.9.x.x\nkafka-consumer-groups.sh --bootstrap-server ${BOOTSTRAP_SERVER}  --new-consumer --describe --group $group\n\n# \u8bb0\u5f55\u5728 __consumer_offsets \u4e2d\u7684\u6d88\u8d39\u7ec4\uff0cKafka \u7248\u672c &gt; 0.9.x.x\nkafka-consumer-groups.sh --bootstrap-server ${BOOTSTRAP_SERVER} --describe --group $group\n\nkafka-consumer-groups.sh --bootstrap-server ${BOOTSTRAP_SERVER} --describe --group my-group --members\n\nkafka-consumer-groups.sh --bootstrap-server ${BOOTSTRAP_SERVER} --describe --group my-group --members --verbose\n\nkafka-consumer-groups.sh --bootstrap-server ${BOOTSTRAP_SERVER} --describe --group my-group --state\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#_4","title":"\u6d88\u8d39\u8005\u9009\u9879","text":"<ul> <li>\u4f7f\u7528 zookeeper \u4fdd\u5b58\u6d88\u8d39\u7ec4\u6570\u636e\uff082.x.x \u7248\u672c\u4ee5\u4e0a\u5e9f\u5f03\uff09: <code>--zookeeper localhost:2181</code></li> <li>\u4f7f\u7528 __consumer_offsets \u4fdd\u5b58\u6d88\u8d39\u7ec4\u6570\u636e: <code>--bootstrap-server localhost:9092</code></li> <li>\u6307\u5b9a group \u540d:<ul> <li><code>--group group1</code></li> <li><code>--consumer-property group.id=group1</code></li> </ul> </li> <li>\u6307\u5b9a topic:<ul> <li><code>--topic foo</code></li> <li><code>--whitelist \".*\"</code></li> </ul> </li> <li>\u6307\u5b9a partition:<ul> <li><code>--partition 0</code></li> </ul> </li> <li>\u6307\u5b9a offset:<ul> <li><code>--from-beginning</code></li> <li><code>--offset 3418783</code></li> </ul> </li> <li>\u6d88\u8d39\u591a\u5c11\u6761\u6d88\u606f:<ul> <li><code>--max-messages 10</code></li> </ul> </li> </ul> <p>ZK Group\uff082.x.x \u7248\u672c\u4ee5\u4e0a\u5e9f\u5f03\uff09</p> <pre><code>kafka-console-consumer.sh --zookeeper ${ZK_CONNECT} --topic test --from-beginning --group group1\n\nkafka-console-consumer.sh --zookeeper ${ZK_CONNECT} --topic test --consumer-property group.id=group1\n</code></pre> <p>KF Group</p> <pre><code>kafka-console-consumer.sh --bootstrap-server ${BOOTSTRAP_SERVER} --topic test\n\nkafka-console-consumer.sh --bootstrap-server ${BOOTSTRAP_SERVER} --whitelist \".*\"\n</code></pre> <p>property</p> <pre><code>kafka-console-consumer.sh --property print.timestamp=true --property print.key=true --bootstrap-server ${BOOTSTRAP_SERVER} --topic __test --from-beginning\n</code></pre> <p>\u4ece\u6307\u5b9a partition, offset \u5f00\u59cb\u6d88\u8d39</p> <pre><code>kafka-console-consumer.sh --bootstrap-server ${BOOTSTRAP_SERVER} --topic logs --partition 0 --offset 3418783\n</code></pre> <p>\u4ece\u6307\u5b9a partition, offset \u5f00\u59cb\u6d88\u8d39\u6307\u5b9a\u6570\u91cf\u6d88\u606f\uff1a</p> <pre><code>kafka-console-consumer.sh --bootstrap-server ${BOOTSTRAP_SERVER} --topic logs --partition 7 --offset 1340190464 --max-messages 10\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#broker","title":"broker \u53c2\u6570(\u52a8\u6001)","text":"<p>\u67e5\u770b\u53c2\u6570\uff1a</p> <pre><code>kafka-configs.sh --bootstrap-server ${BOOTSTRAP_SERVER} --entity-type brokers --describe\n\nkafka-configs.sh --bootstrap-server ${BOOTSTRAP_SERVER} --entity-type brokers --entity-name 0 --describe\n</code></pre> <p>\u8bbe\u7f6e\u526f\u672c\u540c\u6b65\u7684\u9650\u6d41\u53c2\u6570\uff1a</p> <pre><code>kafka-configs.sh --bootstrap-server ${BOOTSTRAP_SERVER} --entity-type brokers --entity-name 0 \\\n    --alter --add-config \"leader.replication.throttled.rate=1024,follower.replication.throttled.rate=1024\"\n</code></pre> <p>\u5220\u9664\u526f\u672c\u540c\u6b65\u9650\u6d41\u53c2\u6570\uff1a</p> <pre><code>kafka-configs.sh --zookeeper ${ZK_CONNECT} -entity-type brokers  --entity-name 0 \\\n    --alter --delete-config 'leader.replication.throttled.rate,follower.replication.throttled.rate'\n\nkafka-configs.sh --bootstrap-server ${BOOTSTRAP_SERVER} -entity-type brokers --entity-name 0 \\\n    --alter --delete-config 'leader.replication.throttled.rate,follower.replication.throttled.rate'\n</code></pre> <p>\u8bbe\u7f6e\u96c6\u7fa4\u7ea7\u522b\u7684\u53c2\u6570</p> <pre><code>kafka-configs.sh --bootstrap-server ${BOOTSTRAP_SERVER} --entity-type brokers --entity-default \\\n    --alter --add-config 'log.cleaner.threads=2'\n</code></pre> <p>\u67e5\u770b\u96c6\u7fa4\u7ea7\u522b\u7684\u53c2\u6570</p> <pre><code>kafka-configs.sh --bootstrap-server ${BOOTSTRAP_SERVER} --entity-type brokers --entity-default --describe\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#topic_1","title":"topic \u53c2\u6570","text":"<p>\u67e5\u770b\u53c2\u6570\uff1a</p> <pre><code>kafka-configs.sh --bootstrap-server ${BOOTSTRAP_SERVER} --entity-type topics --describe\n\nkafka-configs.sh --bootstrap-server ${BOOTSTRAP_SERVER} --entity-type topics --entity-name __test --describe\n</code></pre> <p>\u4fee\u6539\u6d88\u606f\u5927\u5c0f\u9650\u5236\uff1a</p> <pre><code>$ kafka-configs.sh --zookeeper ${ZK_CONNECT} --entity-type topics --entity-name __test \\\n    --alter --add-config max.message.bytes=4194304\n</code></pre> <p>\u4fee\u6539\u6d88\u606f\u4fdd\u7559\u65f6\u957f\uff1a</p> <pre><code>$ kafka-configs.sh --zookeeper ${ZK_CONNECT} --entity-type topics --entity-name __test \\\n    --alter --add-config retention.ms=259200000\n</code></pre> <p>\u4fee\u6539 __consumer_offsets \u4fdd\u7559\u7b56\u7565\uff1a</p> <pre><code>$ kafka-configs.sh --zookeeper ${ZK_CONNECT} --entity-type topics --entity-name __consumer_offsets --describe\n\n$ kafka-configs.sh --zookeeper ${ZK_CONNECT} --entity-type topics --entity-name __consumer_offsets \\\n    --alter --delete-config cleanup.policy\n\n$ kafka-configs.sh --zookeeper ${ZK_CONNECT} --entity-type topics --entity-name __consumer_offsets \\\n    --alter --add-config retention.ms=2592000000\n$ kafka-configs.sh --zookeeper ${ZK_CONNECT} --entity-type topics --entity-name __consumer_offsets \\\n    --alter --add-config cleanup.policy=delete\n\n$ kafka-configs.sh --zookeeper ${ZK_CONNECT} --entity-type topics --entity-name __consumer_offsets \\\n    --alter --delete-config retention.ms\n$ kafka-configs.sh --zookeeper ${ZK_CONNECT} --entity-type topics --entity-name __consumer_offsets \\\n    --alter --add-config cleanup.policy=compact\n</code></pre> <p>\u8bbe\u7f6e\u526f\u672c\u540c\u6b65\u6d41\u91cf\u9650\u5236\uff1a</p> <pre><code>kafka-configs.sh --zookeeper ${ZK_CONNECT} --entity-type topics --entity-name test-throttled \\\n    --alter --add-config \"leader.replication.throttled.replicas=*,follower.replication.throttled.replicas=*\"\n</code></pre> <p>\u5220\u9664\u526f\u672c\u540c\u6b65\u6d41\u91cf\u9650\u5236\uff1a</p> <pre><code>kafka-configs.sh --zookeeper ${ZK_CONNECT} -entity-type topics --entity-name test-throttled \\\n    --alter --delete-config 'leader.replication.throttled.replicas,follower.replication.throttled.replicas'\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#leader","title":"\u9009\u4e3e leader","text":"<p>\u89e6\u53d1\u96c6\u7fa4\u5185\u6240\u6709 topic partition \u7684\u6700\u4f18 leader \u9009\u4e3e:</p> <pre><code>$ kafka-preferred-replica-election.sh --zookeeper ${ZK_CONNECT}\n</code></pre> <p>\u89e6\u53d1 <code>partitions.json</code> \u6587\u4ef6\u6307\u5b9a\u7684 topic partition \u7684\u6700\u4f18 leader \u9009\u4e3e:</p> <pre><code>kafka-preferred-replica-election.sh --zookeeper ${ZK_CONNECT} --path-to-json-file partitions.json\n</code></pre> <p><code>partitions.json</code> \u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>{\n    \"partitions\": [\n        {\n            \"partition\": 1,\n            \"topic\": \"__test\"\n        }\n    ]\n}\n</code></pre> <p>\u4ece 2.4.0 \u7248\u672c\u5f00\u59cb\uff0c\u63a8\u8350\u4f7f\u7528 <code>kafka-leader-election.sh</code> \u89e6\u53d1\u9009\u4e3e</p> <p>\u53ef\u4ee5\u901a\u8fc7 <code>--topic</code>, <code>--partition</code> \u53c2\u6570\u6307\u5b9a topic, partition\uff0c\u901a\u8fc7 <code>--election-type</code> \u6307\u5b9a\u9009\u4e3e\u7c7b\u578b\u4e3a preferred/unclean</p> <pre><code>$ kafka-leader-election.sh --bootstrap-server ${BOOTSTRAP_SERVER} --topic &lt;topic&gt; --partition &lt;partition&gt; --election-type preferred\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>--path-to-json-file</code> \u6307\u5b9a\u6587\u4ef6\u5305\u542b\u7684 topic partition \u7684\u6700\u4f18 leader \u9009\u4e3e</p> <pre><code>$ kafka-leader-election.sh --bootstrap-server ${BOOTSTRAP_SERVER} --path-to-json-file partitions.json --election-type preferred\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#_5","title":"\u5220\u9664\u6d88\u8d39\u7ec4","text":"<p>ZK \u7c7b\u578b</p> <pre><code>$ kafka-consumer-groups.sh --zookeeper ${ZK_CONNECT} --delete --group console-consumer-38645\n</code></pre> <p>KF \u7c7b\u578b</p> <pre><code>$ kafka-consumer-groups.sh --bootstrap-server ${BOOTSTRAP_SERVER} --delete --group console-consumer-97214\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#topic-offset","title":"\u67e5\u770b topic offset","text":"<p>\u6700\u7ec8\u7684 offset</p> <pre><code>$ kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list ${BOOTSTRAP_SERVER} --time -1 --topic test\n</code></pre> <p>\u6700\u65e9\u7684 offset</p> <pre><code>$ kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list ${BOOTSTRAP_SERVER} --time -2 --topic test\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#consumer-current-offset","title":"\u8bbe\u7f6e consumer current offset","text":"<p>\u91cd\u7f6e offset \u5230\u6700\u65b0\u4f4d\u7f6e\uff1a</p> <pre><code>kafka-consumer-groups.sh --bootstrap-server ${BOOTSTRAP_SERVER}  --reset-offsets --to-latest --group $group --topic $topic --execute\n</code></pre> <p>\u8bbe\u7f6e\u5230\u6307\u5b9a\u7684 offset\uff1a</p> <pre><code>kafka-consumer-groups.sh --bootstrap-server ${BOOTSTRAP_SERVER} --group $group --reset-offsets --to-offset 6250 --topic $topic --execute\n</code></pre> <p>\u6839\u636e\u65f6\u95f4\u8bbe\u7f6e\uff0c\u8bbe\u7f6e\u5230\u5927\u4e8e\u7b49\u4e8e\u8be5\u65f6\u95f4\u7684\u7b2c\u4e00\u4e2a offset\uff1a</p> <pre><code>kafka-consumer-groups.sh --bootstrap-server ${BOOTSTRAP_SERVER} --group $group --reset-offsets --to-datetime 2019-12-12T16:59:59.000 --topic $topic --execute\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#__consumer_offsets","title":"\u8bfb\u53d6 __consumer_offsets","text":"<p>0.11.0.0 \u4e4b\u524d\u7248\u672c</p> <pre><code>$ kafka-console-consumer.sh --formatter \"kafka.coordinator.GroupMetadataManager\\$OffsetsMessageFormatter\" --zookeeper ${ZK_CONNECT} --topic __consumer_offsets\n</code></pre> <p>0.11.0.0 \u4e4b\u540e\u7248\u672c(\u542b)</p> <pre><code>$ kafka-console-consumer.sh --formatter \"kafka.coordinator.group.GroupMetadataManager\\$OffsetsMessageFormatter\" --bootstrap-server ${BOOTSTRAP_SERVER} --topic __consumer_offsets\n</code></pre> <p>\u683c\u5f0f\uff1a</p> <pre><code>[Group, Topic, Partition]::[OffsetMetadata[Offset, Metadata], CommitTime, ExpirationTime]\n</code></pre> <p>\u5206\u533a\u89c4\u5219\uff1a</p> <pre><code>Math.abs(groupID.hashCode()) % numPartitions\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#_6","title":"\u67e5\u770b\u65e5\u5fd7/\u7d22\u5f15\u6587\u4ef6","text":"<p>\u67e5\u770b\u65e5\u5fd7\u6587\u4ef6</p> <pre><code>$ kafka-run-class.sh kafka.tools.DumpLogSegments --files ./00000000000000283198.log --print-data-log\n</code></pre> <p>\u67e5\u770b\u7d22\u5f15\u6587\u4ef6</p> <pre><code>$ kafka-run-class.sh kafka.tools.DumpLogSegments --files 0000000000000045.timeindex\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#api-version","title":"\u67e5\u770b\u8bf7\u6c42\u4f7f\u7528\u7684 API Version","text":"<pre><code>$ kafka-broker-api-versions.sh  --bootstrap-server ${BOOTSTRAP_SERVER}\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#lag","title":"\u67e5\u770b\u526f\u672c\u540c\u6b65 lag","text":"<pre><code>kafka-replica-verification.sh --broker-list ${BOOTSTRAP_SERVER}\n\nkafka-replica-verification.sh --broker-list ${BOOTSTRAP_SERVER} --topic-white-list .*\n</code></pre>"},{"location":"1-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#broker-topic","title":"\u83b7\u53d6 broker topic \u5206\u533a\u5b9e\u9645\u76ee\u5f55\u5206\u5e03","text":"<pre><code>kafka-log-dirs.sh --bootstrap-server localhost:9092  --describe [--broker-list \"0,1,2\"] [--topic-list \"t1,t2\"]\n</code></pre>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-move-partiton/","title":"\u624b\u52a8\u8fc1\u79fb kafka topic \u5206\u533a\u6570\u636e","text":""},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-move-partiton/#_1","title":"\u76ee\u7684","text":"<p>\u76ee\u524d\u9047\u5230 2 \u7c7b\u4f7f\u7528\u573a\u666f\uff1a</p> <ol> <li>Kafka \u5355\u4e2a\u8282\u70b9\u4e0a\u6302\u8f7d\u591a\u5757\u78c1\u76d8\uff0c\u78c1\u76d8\u4f7f\u7528\u7387\u4e0d\u5747\u5300\uff0c\u6709\u7684\u78c1\u76d8\u5df2\u7ecf 100% \u4e86\uff0c\u6709\u7684\u78c1\u76d8\u8fd8\u6709\u5927\u91cf\u7a7a\u4f59\uff0c\u8fd9\u65f6\u53ef\u4ee5\u4ece\u4f7f\u7528\u7387\u9ad8\u7684\u78c1\u76d8\u79fb\u52a8\u90e8\u5206\u5206\u533a\u5230\u4f7f\u7528\u7387\u4f4e\u7684\u78c1\u76d8\u4e0a\u3002</li> <li>kafka \u5355\u4e2a\u8282\u70b9\u78c1\u76d8\u6545\u969c\uff0c\u6570\u636e\u4e22\u5931\uff0c\u4f46\u662f topic \u5206\u533a leader \u5e76\u672a\u5207\u6362\uff0cleader \u4e3a <code>-1</code>\uff0c\u5982\u679c\u5206\u533a\u526f\u672c\u6570\u636e\u8fd8\u5728\uff0c\u6b64\u65f6\u53ef\u4ee5\u5c06\u5206\u533a\u526f\u672c\u6570\u636e\u624b\u52a8\u79fb\u52a8\u5230 leader \u8282\u70b9\u4e0a\uff0c\u6062\u590d\u6570\u636e\u3002</li> </ol> <p>\u6ce8\u610f\uff1a\u8fd9\u91cc\u5e76\u4e0d\u4f1a\u6539\u53d8\u5206\u533a\u5728 broker \u4e0a\u7684\u5206\u5e03\u60c5\u51b5\uff0c\u79fb\u52a8\u540e\u5206\u533a\u8fd8\u5728\u539f\u6765\u7684 broker \u4e0a\u3002\u64cd\u4f5c\u53ea\u662f\u5728\u540c\u4e00\u4e2a broker \u4e0d\u540c\u6570\u636e\u76ee\u5f55\u4e0b\u79fb\u52a8\u5206\u533a\uff0c\u6216\u8005\u5728\u5206\u533a leader, follower \u6240\u5728 broker \u4e4b\u95f4\u590d\u5236\u5206\u533a\u6570\u636e\u3002\u5982\u679c\u60f3\u6539\u53d8\u5206\u533a\u5728 broker \u4e0a\u7684\u5206\u5e03\u60c5\u51b5\uff0c\u5c06\u5206\u533a\u79fb\u52a8\u5230\u539f\u6765\u6ca1\u6709\u5206\u5e03\u7684 broker \u4e0a\uff0c\u8bf7\u53c2\u8003\u300c\u91cd\u65b0\u5206\u914d\u5206\u533a\u300d\u64cd\u4f5c\u8bf4\u660e\u3002</p> <p>kafka 1.1.0 \u4e4b\u540e\u300c\u91cd\u65b0\u5206\u914d\u5206\u533a\u300d\u65b9\u6848\u53ef\u4ee5\u6307\u5b9a\u5206\u533a\u76ee\u5f55\uff0c\u573a\u666f 1 \u53ef\u4ee5\u53c2\u8003\u300c\u91cd\u65b0\u5206\u914d\u5206\u533a\u300d\u64cd\u4f5c\u8bf4\u660e\u89e3\u51b3\uff0c\u4e0d\u9700\u8981\u624b\u52a8\u8fc1\u79fb\u4e86\u3002</p>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-move-partiton/#_2","title":"\u539f\u7406","text":"<p>kafka \u6570\u636e\u76ee\u5f55\u7531\u914d\u7f6e\u9879 <code>log.dirs</code>(\u6216 <code>log.dir</code>) \u6307\u5b9a\uff0c\u6570\u636e\u76ee\u5f55\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>- &lt;log.dirs&gt;\n    - &lt;topic.name&gt;-&lt;partition.id&gt;\n        - &lt;segment.offset&gt;.log\n        - &lt;segment.offset&gt;.index\n        - &lt;segment.offset&gt;.timeindex\n        - ...\n        - leader-epoch-checkpoint\n    ...\n    - cleaner-offset-checkpoint\n    - log-start-offset-checkpoint\n    - meta.properties\n    - recovery-point-offset-checkpoint\n    - replication-offset-checkpoint\n- ...\n</code></pre> <p><code>log.dir</code> \u76ee\u5f55\u4e0b\uff0c\u6bcf\u4e2a topic \u5206\u533a\u4ee5 <code>&lt;topic.name&gt;-&lt;partition.id&gt;</code> \u4e3a\u76ee\u5f55\u5b58\u50a8\u81ea\u8eab\u6570\u636e\uff0c\u4e0b\u9762\u6709\u591a\u4e2a segment \u6587\u4ef6\u4e0e\u5176\u7d22\u5f15\u6587\u4ef6:</p> <ol> <li>segment \u6587\u4ef6(\u65e5\u5fd7\u5206\u6bb5\u6587\u4ef6)\uff1a\u6587\u4ef6\u540d\u4e3a <code>&lt;segment.offset&gt;.log</code>\uff0c\u5b9e\u9645\u7684\u6570\u636e\u6587\u4ef6\uff0c\u6bcf\u4e2a segment \u6587\u4ef6\u90fd\u5bf9\u5e94 2 \u4e2a\u7d22\u5f15\u6587\u4ef6\uff1a<ol> <li>\u504f\u79fb\u91cf\u7d22\u5f15\u6587\u4ef6\uff1a\u6587\u4ef6\u540d\u4e3a <code>&lt;segment.offset&gt;.index</code>\uff0c\u5efa\u7acb\u6d88\u606f\u504f\u79fb\u91cf(offset)\u5230\u7269\u7406\u5730\u5740\u4e4b\u95f4\u7684\u6620\u5c04\u5173\u7cfb</li> <li>\u65f6\u95f4\u6233\u7d22\u5f15\u6587\u4ef6\uff1a\u6587\u4ef6\u540d\u4e3a <code>&lt;segment.offset&gt;.timeindex</code>\uff0c\u6839\u636e\u6307\u5b9a\u7684\u65f6\u95f4\u6233(timestamp)\u6765\u67e5\u627e\u5bf9\u5e94\u7684\u504f\u79fb\u4fe1\u606f</li> </ol> </li> </ol> <p><code>log.dir</code> \u76ee\u5f55\u4e0b\u9664\u4e86\u4ee5 <code>&lt;topic.name&gt;-&lt;partition.id&gt;</code> \u4e3a\u540d\u7684\u6570\u636e\u76ee\u5f55\uff0c\u8fd8\u6709 4 \u4e2a\u8bb0\u5f55 topic partition offset \u7684\u6587\u4ef6:</p> <ol> <li><code>cleaner-offset-checkpoint</code></li> <li><code>log-start-offset-checkpoint</code></li> <li><code>recovery-point-offset-checkpoint</code></li> <li><code>replication-offset-checkpoint</code></li> </ol> <p>\u8fd9\u4e9b\u6587\u4ef6\u5185\u5bb9\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>0\n&lt;record_partition_num&gt;\n&lt;topic&gt; &lt;partition.id&gt; &lt;offset&gt;\n&lt;topic&gt; &lt;partition.id&gt; &lt;offset&gt;\n&lt;topic&gt; &lt;partition.id&gt; &lt;offset&gt;\n...\n...\n</code></pre> <p><code>&lt;record_partition_num&gt;</code> \u4e3a\u6587\u4ef6\u4e2d\u8bb0\u5f55\u7684\u6761\u6570\uff0c\u4e0b\u9762\u7684\u6bcf\u4e00\u6761\u8bb0\u5f55\u4e3a\u4ee5\u7a7a\u683c\u5206\u9694\u7684 topic \u540d\uff0cpartition\uff0c\u548c\u5bf9\u5e94 offset\u3002</p> <p>\u79fb\u52a8\u5206\u533a\u6570\u636e\uff0c\u5c31\u662f\u505c\u6b62 kafka \u670d\u52a1\uff0c\u6253\u5305 <code>&lt;topic.name&gt;-&lt;partition.id&gt;</code> \u76ee\u5f55\u6570\u636e\uff0c\u79fb\u52a8\u5230\u5176\u4ed6\u76ee\u5f55\uff0c\u5e76\u4fee\u6539\u5bf9\u5e94\u76ee\u5f55\u7684 <code>recovery-point-offset-checkpoint</code> \u548c <code>replication-offset-checkpoint</code> \u6587\u4ef6\u8bb0\u5f55</p>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-move-partiton/#_3","title":"\u6b65\u9aa4\u793a\u4f8b","text":"<p>\u5047\u8bbe\u6709 2 \u4e2a\u78c1\u76d8 <code>/data1/kafka-logs/</code> \u548c <code>/data2/kafka-logs</code>\uff0c\u9700\u8981\u628a <code>/data1/kafka-logs/</code> \u4e0b <code>test_topic</code> \u5206\u533a 1 \u79fb\u52a8\u5230 <code>/data2/kafka-logs/</code></p>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-move-partiton/#1","title":"1. \u505c\u6b62\u8282\u70b9\u670d\u52a1","text":""},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-move-partiton/#2","title":"2. \u79fb\u52a8\u5206\u533a\u6570\u636e","text":"<p>\u6253\u5305\u6570\u636e\u76ee\u5f55\uff1a</p> <pre><code>cd /data1/kafka-logs/\ntar zcvf test_topic-1.tar.gz test_topic-1\n</code></pre> <p>\u5982\u679c 2 \u5757\u78c1\u76d8\u662f\u540c\u4e00\u4e2a broker \u4e0b</p> <pre><code>mv test_topic-1.tar.gz /data2/kafka-logs/\nrm test_topic-1.tar.gz\nrm -rf test_topic-1\n</code></pre>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-move-partiton/#3-offset","title":"3. \u4fee\u6539 offset \u6587\u4ef6","text":"<p>\u8fdb\u5165 <code>/data1/kafka-logs</code> \u76ee\u5f55\u67e5\u770b <code>replication-offset-checkpoint</code>, <code>replication-offset-checkpoint</code> \u6587\u4ef6\uff0c\u5047\u8bbe\u5185\u5bb9\u5982\u4e0b:</p> <p>recovery-point-offset-checkpoint</p> <pre><code>0\n102\n...\ntest_topic 1 144458735\n...\n</code></pre> <p>replication-offset-checkpoint</p> <pre><code>0\n102\n...\ntest_topic 1 144465512\n...\n</code></pre> <p>\u8fdb\u5165 <code>/data2/kafka-logs</code> \u76ee\u5f55\u67e5\u770b <code>replication-offset-checkpoint</code>, <code>replication-offset-checkpoint</code> \u6587\u4ef6\uff0c\u5047\u8bbe\u5185\u5bb9\u5982\u4e0b:</p> <p>recovery-point-offset-checkpoint</p> <pre><code>0\n99\n...\n...\n</code></pre> <p>replication-offset-checkpoint</p> <pre><code>0\n99\n...\n...\n</code></pre>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-move-partiton/#31-data2kafka-logs-test_topic","title":"3.1 \u5728 /data2/kafka-logs \u5bf9\u5e94\u6587\u4ef6\u4e0b\u6dfb\u52a0 test_topic \u7684\u8bb0\u5f55","text":"<p>\u8fdb\u5165 <code>/data2/kafka-logs</code> \u76ee\u5f55\uff0c\u5c06 test_topic \u7684\u8bb0\u5f55\u6dfb\u52a0\u5230\u5bf9\u5e94\u7684\u6587\u4ef6\u4e2d\uff0c\u5e76\u589e\u52a0\u8bb0\u5f55\u6570\uff0c\u6587\u4ef6\u5185\u5bb9\u4fee\u6539\u5982\u4e0b\uff1a</p> <p>recovery-point-offset-checkpoint</p> <pre><code>0\n100\n...\n...\ntest_topic 1 144458735\n</code></pre> <p>replication-offset-checkpoint</p> <pre><code>0\n100\n...\n...\ntest_topic 1 144465512\n</code></pre>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-move-partiton/#32-data1kafka-logs-test_topic","title":"3.2 \u5728 /data1/kafka-logs \u5bf9\u5e94\u6587\u4ef6\u4e0b\u53bb\u9664 test_topic \u7684\u8bb0\u5f55","text":"<p>\u8fdb\u5165 <code>/data1/kafka-logs</code> \u76ee\u5f55\uff0c\u5c06\u5bf9\u5e94\u7684\u6587\u4ef6\u4e2d test_topic \u7684\u8bb0\u5f55\u53bb\u9664\uff0c\u5e76\u51cf\u5c11\u8bb0\u5f55\u6570\uff0c\u6587\u4ef6\u5185\u5bb9\u4fee\u6539\u5982\u4e0b\uff1a</p> <p>recovery-point-offset-checkpoint</p> <pre><code>0\n101\n...\n...\n</code></pre> <p>replication-offset-checkpoint</p> <pre><code>0\n101\n...\n...\n</code></pre> <p>\u8fd9\u91cc\u7684\u793a\u4f8b\u662f\u540c\u4e00\u8282\u70b9\u4e0d\u540c\u78c1\u76d8\u4e4b\u95f4\u79fb\u52a8\u5206\u533a\uff0c\u5982\u679c\u662f\u4e0d\u540c\u8282\u70b9\u4e4b\u95f4\u6062\u590d\u6570\u636e\uff0c\u8fd9\u91cc\u7684\u8bb0\u5f55\u4e0d\u7528\u53bb\u9664</p>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-move-partiton/#4","title":"4. \u542f\u52a8\u8282\u70b9\u670d\u52a1","text":""},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-performance-estimate/","title":"kafka \u7406\u8bba\u6781\u9650\u6027\u80fd\u9884\u4f30","text":"<p>\u53c2\u8003\uff1aBest practices for right-sizing your Apache Kafka clusters to optimize performance and cost</p> <pre><code>max(Tcluster) &lt;= min{\n  max(Tstorage) * #brokers / r,\n  max(Tcds_network) * #brokers / r,\n\n  max(Tbcc_network) * #brokers / (#consumer_groups + r - 1)\n}\n</code></pre>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-performance-estimate/#_1","title":"\u7406\u60f3\u96c6\u7fa4","text":"<p>\u5047\u8bbe\u96c6\u7fa4\u5728\u7406\u60f3\u72b6\u6001\uff0c\u5373\uff1a</p> <ul> <li>\u6240\u6709 topic \u7684 \u5206\u533a leader, \u526f\u672c\u90fd\u5747\u5300\u5206\u5e03\u5728\u6bcf\u4e2a broker \u4e0a</li> <li>\u751f\u4ea7\u8005/\u6d88\u8d39\u8005\u5bf9 topic \u7684\u6bcf\u4e2a\u5206\u533a\u7684\u8bfb\u5199\u6d41\u91cf\u90fd\u662f\u76f8\u540c\u7684</li> <li>\u751f\u4ea7\u6d88\u8d39\u884c\u4e3a\u4e4b\u95f4\u662f\u540c\u6b65\u7684\uff0c\u6ca1\u6709\u5ef6\u8fdf</li> </ul> <p>\u8fd9\u65f6\u6240\u6709\u7684 broker \u90fd\u627f\u8f7d\u76f8\u540c\u7684\u6d41\u91cf\u548c\u538b\u529b\u3002</p> <p>\u5047\u8bbe\uff1a</p> <ul> <li>\u96c6\u7fa4\u5199\u5165\u6d41\u91cf\uff1a<code>Tcluster</code></li> <li>\u96c6\u7fa4\u8282\u70b9\u6570\uff1a<code>#broker</code></li> <li>\u4e3b\u9898\u526f\u672c\u6570\uff1a<code>r</code></li> <li>\u6d88\u8d39\u7ec4\u6570\uff1a<code>#consumer_groups</code></li> </ul> <pre><code>\u8282\u70b9\u6d41\u5165\u6570\u636e = \u751f\u4ea7\u8005\u5199\u5165\u8282\u70b9\u6d41\u91cf + \u526f\u672c\u540c\u6b65\u62c9\u53d6\u6d41\u91cf\n             = Tcluster / #brokers + Tcluster / #brokers * (r - 1)\n             = Tcluster / #brokers * r\n</code></pre> <pre><code>\u8282\u70b9\u6d41\u51fa\u6570\u636e = \u6d88\u8d39\u7ec4\u8bfb\u53d6\u8282\u70b9\u6d41\u91cf + \u526f\u672c\u540c\u6b65\u8bfb\u53d6\u6d41\u91cf\n             = Tcluster / #brokers * #consumer_groups + Tcluster / #brokers * (r \u2013 1)\n             = Tcluster / #brokers * (#consumer_groups + r - 1)\n</code></pre>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-performance-estimate/#_2","title":"\u78c1\u76d8\u74f6\u9888","text":"<pre><code>Tstorage = \u8282\u70b9\u6d41\u5165\u6570\u636e\n         = \u751f\u4ea7\u8005\u5199\u5165\u6d41\u91cf + \u526f\u672c\u540c\u6b65\u5199\u5165\u6d41\u91cf\n         = Tcluster / #brokers + Tcluster / #brokers * (r-1)\n         = Tcluster / #brokers * r\n\nmax(Tcluster) &lt;= max(Tstorage) * #brokers / r\n\n#broker = Tcluster * r / max(Tstorage)\n</code></pre>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-performance-estimate/#_3","title":"\u8282\u70b9\u5e26\u5bbd\u74f6\u9888","text":"<pre><code>Tbcc_network = \u6d88\u8d39\u7ec4\u8bfb\u53d6\u6d41\u91cf + \u526f\u672c\u540c\u6b65\u8bfb\u53d6\u6d41\u91cf\n             = Tcluster / #brokers * #consumer_groups + Tcluster / #brokers * (r \u2013 1)\n             = Tcluster / #brokers * (#consumer_groups + r - 1)\n\nmax(Tcluster) &lt;= max(Tbcc_network) * #brokers / (#consumer_groups + r - 1)\n\n#broker = Tcluster * (#consumer groups + r - 1) / max(Tbcc_network)\n</code></pre>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-proxy/","title":"kafka \u5916\u7f51 nginx \u4ee3\u7406\u8bbf\u95ee\u96c6\u7fa4","text":"<p>\u8fdb\u884c\u751f\u4ea7\u6216\u8005\u6d88\u8d39\u6d3b\u52a8\u65f6\uff0ckafka \u5ba2\u6237\u7aef\u4f1a\u4e3b\u52a8\u83b7\u53d6\u96c6\u7fa4\u7684\u5143\u4fe1\u606f\uff0c\u5143\u4fe1\u606f\u5305\u542b broker id \u4e0e broker \u5730\u5740\u4e4b\u95f4\u7684\u5bf9\u5e94\u5173\u7cfb\uff0c\u4ee5\u53ca topic \u7684 partition, replica, leader \u4fe1\u606f\u3002\u5f53\u5177\u4f53\u8bfb/\u5199\u67d0\u4e2a topic \u7684\u67d0\u4e2a partition \u65f6\uff0c\u5ba2\u6237\u7aef\u5fc5\u987b\u6839\u636e\u5143\u4fe1\u606f\u627e\u5230\u4ee3\u8868\u8be5 partition leader \u7684 broker id\uff0c\u518d\u6839\u636e broker id \u627e\u5230 broker \u7684\u5730\u5740\u3002</p> <p>\u914d\u7f6e kafka \u8f6c\u53d1\u5e38\u89c1\u7684\u9519\u8bef\u5c31\u662f\u5ffd\u7565\u4e86\u5ba2\u6237\u7aef\u4f1a\u4e3b\u52a8\u83b7\u53d6\u96c6\u7fa4\u5730\u5740\u7684\u7279\u6027\uff0c\u4ec5\u4ec5\u7528\u5916\u7f51 IP \u4ee3\u7406\u5185\u7f51\u4e0b\u7684 Kafka broker IP\uff0c\u8fd9\u6837\u5ba2\u6237\u7aef\u5728\u521d\u6b21\u8fde\u63a5\u65f6\u6ca1\u6709\u95ee\u9898\uff0c\u4f46\u662f\u7b2c\u4e00\u6b21\u8fde\u63a5\u6210\u529f\u540e\uff0c\u5ba2\u6237\u7aef\u4e3b\u52a8\u83b7\u53d6\u5230\u7684\u96c6\u7fa4 broker \u5730\u5740\u8fd8\u662f kafka listeners \u914d\u7f6e\u7684\u5185\u7f51\u5730\u5740\uff0c\u56e0\u6b64\u4e4b\u540e\u7684\u4efb\u4f55\u8bf7\u6c42\u90fd\u4f1a\u53d1\u5411\u5185\u7f51\u5730\u5740\u800c\u4e0d\u662f\u4ee3\u7406\u5730\u5740\u3002</p> <p>\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u5173\u952e\u662f\u8ba9\u5ba2\u6237\u7aef\u521d\u6b21\u8fde\u63a5\u6210\u529f\u540e\uff0c\u4e3b\u52a8\u83b7\u53d6\u5230\u7684\u96c6\u7fa4 broker \u5730\u5740\u8fd8\u662f\u6307\u5411\u4ee3\u7406 IP\uff0c\u6709 2 \u79cd\u89e3\u51b3\u65b9\u6cd5\uff1a</p> <ol> <li>\u4fee\u6539 kafka listeners \u7684\u5730\u5740\u4e3a kafka broker \u8282\u70b9\u7684 hostname\uff0c\u7136\u540e\u5728\u5ba2\u6237\u7aef\u6240\u5728\u7684\u4e3b\u673a\u914d\u7f6e <code>/etc/hosts</code> \u6587\u4ef6\uff0c\u6dfb\u52a0 kafka listeners \u914d\u7f6e\u7684 hostname\uff0c\u5e76\u5c06\u5bf9\u5e94\u7684 IP \u914d\u7f6e\u4e3a\u4ee3\u7406 IP</li> <li>\u4fee\u6539 kafka <code>advertised.listeners</code> \u7684\u5730\u5740\u4e3a\u4ee3\u7406 IP\uff0c\u7b49\u4e8e\u76f4\u63a5\u5411\u5ba2\u6237\u7aef\u5ba3\u544a\u901a\u8fc7\u4ee3\u7406\u5730\u5740\u8bbf\u95ee\u81ea\u5df1</li> </ol> <p>kafka broker \u6ce8\u518c\u7684\u5730\u5740\u53ef\u4ee5\u5728 zookeeper \u7684 <code>/brokers/ids/&lt;broker_id&gt;</code> \u8def\u5f84\u4e0b\u67e5\u770b\u3002</p>","tags":["kafka","proxy"]},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-proxy/#_1","title":"\u51c6\u5907\u4fe1\u606f","text":"<ol> <li> <p>kafka \u96c6\u7fa4\u5404\u8282\u70b9\u7684\u5185\u7f51 ip \u548c hostname \u7684\u5bf9\u5e94\u4fe1\u606f</p> <pre><code>10.13.8.59  kafka1\n10.13.76.7  kafka2\n10.13.79.81 kafka3\n</code></pre> </li> <li> <p>nginx \u4ee3\u7406\u6240\u5728\u673a\u5668</p> <pre><code>\u5185\u7f51ip\uff1a10.13.9.72\n\u5916\u7f51ip\uff1a106.75.143.227\n</code></pre> </li> </ol>","tags":["kafka","proxy"]},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-proxy/#1-hosts","title":"\u65b9\u6cd51\uff1a\u5229\u7528 hosts \u6587\u4ef6","text":"","tags":["kafka","proxy"]},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-proxy/#kafka-broker","title":"\u914d\u7f6e kafka broker \u76d1\u542c\u5730\u5740/\u7aef\u53e3","text":"<p>\u4fee\u6539\u6bcf\u4e2a kafka broker \u7684\u914d\u7f6e\u6587\u4ef6 <code>server.properties</code>\uff0c\u5c06\u76d1\u542c\u5730\u5740\u6539\u4e3a\u8be5\u8282\u70b9\u7684 hostname\uff0c\u4f8b\u5982 kafka1 \u4e0a\u914d\u7f6e\uff1a</p> <pre><code>listeners=PLAINTEXT://kafka1:9092\n#advertised.listeners=PLAINTEXT://kafka1:9092\n</code></pre> <p>\u8ba9\u6bcf\u4e2a broker \u6ce8\u518c\u5230 zookeeper \u7684\u76d1\u542c\u5730\u5740\u4e3a\u5f53\u524d\u8282\u70b9\u7684 hostname\uff0c\u5e76\u4fee\u6539\u7aef\u53e3\uff0c\u8ba9\u6bcf\u4e2a broker \u4f7f\u7528\u4e0d\u540c\u7aef\u53e3\uff08\u4e4b\u540e\u4f1a\u7528\u540c\u4e00\u4e2a\u4e3b\u673a\u7684 nginx \u4ee3\u7406\u6240\u6709 kafka broker\uff0c\u6240\u4ee5\u9700\u8981\u4f7f\u7528\u7aef\u53e3\u8fdb\u884c\u533a\u5206\uff0c\u5982\u679c\u53ef\u4ee5\u505a\u5230 nginx \u4ee3\u7406\u673a\u5668\u548c kafka broker \u6570\u91cf\u4e00\u81f4\uff0c\u5219\u4e0d\u9700\u8981\u4fee\u6539\u9ed8\u8ba4\u7aef\u53e3\uff09</p>","tags":["kafka","proxy"]},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-proxy/#nginx","title":"\u914d\u7f6e nginx \u4ee3\u7406","text":"<p>\u7f16\u8f91 <code>/etc/nginx/nginx.conf</code>\uff0c\u589e\u52a0 stream \u914d\u7f6e</p> <pre><code>$ vim /etc/nginx/nginx.conf\n</code></pre> <pre><code>stream {\n    log_format proxy '$remote_addr [$time_local] '\n                 '$protocol $status $bytes_sent $bytes_received '\n                 '$session_time \"$upstream_addr\" '\n                 '\"$upstream_bytes_sent\" \"$upstream_bytes_received\" \"$upstream_connect_time\"';\n\n    access_log /var/log/nginx/tcp-access.log proxy;\n    open_log_file_cache off;\n\n    # \u7edf\u4e00\u653e\u7f6e\uff0c\u65b9\u4fbf\u7ba1\u7406\n    include /etc/nginx/tcpConf.d/*.conf;\n}\n</code></pre> <p>\u4e0b\u8f7d nginx.conf</p> <p>\u521b\u5efa <code>/etc/nginx/tcpConf.d/</code> \u76ee\u5f55</p> <pre><code>$ mkdir -p /etc/nginx/tcpConf.d/\n</code></pre> <p>\u7f16\u8f91 <code>/etc/nginx/tcpConf.d/kafka.conf</code> \u914d\u7f6e\u6587\u4ef6</p> <pre><code>$ vim /etc/nginx/tcpConf.d/kafka.conf\n</code></pre> <pre><code>upstream tcp9092 {\n    server 10.13.8.59:9092;\n}\nupstream tcp9093 {\n    server 10.13.76.7:9093;\n}\nupstream tcp9094 {\n    server 10.13.79.81:9094;\n}\n\nserver {\n    listen 9092;\n    proxy_connect_timeout 8s;\n    proxy_timeout 24h;\n    proxy_pass tcp9092;\n}\nserver {\n    listen 9093;\n    proxy_connect_timeout 8s;\n    proxy_timeout 24h;\n    proxy_pass tcp9093;\n}\nserver {\n    listen 9094;\n    proxy_connect_timeout 8s;\n    proxy_timeout 24h;\n    proxy_pass tcp9094;\n}\n</code></pre> <p>\u4e0b\u8f7d kafka.conf</p> <p>\u6d4b\u8bd5 nginx \u914d\u7f6e\uff1a</p> <pre><code>$ nginx -t\n</code></pre> <p>\u5982\u679c\u6ca1\u6709\u9519\u8bef\uff0c\u5e94\u7528 nginx \u914d\u7f6e\uff1a</p> <pre><code>$ nginx -s reload\n</code></pre> <p>\u8fd9\u91cc nginx \u4ee3\u7406\u4f1a\u5c06\u672c\u5730 9092\uff0c9093\uff0c9094 \u7aef\u53e3\u7684\u8bf7\u6c42\u8f6c\u53d1\u5230\u5bf9\u5e94\u7684 kafka broker \u4e0a</p>","tags":["kafka","proxy"]},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-proxy/#_2","title":"\u914d\u7f6e\u5ba2\u6237\u7aef\u673a\u5668","text":"<p>\u4fee\u6539\u5ba2\u6237\u7aef hosts \u6587\u4ef6\uff08106.75.143.227 \u4e3a nginx \u6240\u5728\u673a\u5668\u5916\u7f51ip\uff09\uff1a</p> <pre><code>106.75.143.227 kafka1\n106.75.143.227 kafka2\n106.75.143.227 kafka3\n</code></pre>","tags":["kafka","proxy"]},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-proxy/#2-advertisedlisteners","title":"\u65b9\u6cd52\uff1a\u5229\u7528 advertised.listeners \u914d\u7f6e","text":"","tags":["kafka","proxy"]},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-proxy/#kafka-broker_1","title":"\u914d\u7f6e kafka broker \u76d1\u542c\u5730\u5740/\u7aef\u53e3","text":"<p>\u4fee\u6539\u6bcf\u4e2a kafka broker \u7684\u914d\u7f6e\u6587\u4ef6 <code>server.properties</code></p> <pre><code>listeners=BROKER_DATA://:9090,BROKER_CONTROL://:9091,EXT_CLIENT://:9092\n\nadvertised.listeners=BROKER_DATA://kafka1:9090,BROKER_CONTROL://kafka1:9091,EXT_CLIENT://106.75.143.227:9092\n\nlistener.security.protocol.map=BROKER_DATA:PLAINTEXT,BROKER_CONTROL:PLAINTEXT,EXT_CLIENT:PLAINTEXT\n\n# broker data \u5185\u90e8\u4ea4\u4e92\ninter.broker.listener.name=BROKER_DATA\n\n# broker control \u5185\u90e8\u4ea4\u4e92\ncontrol.plane.listener.name=BROKER_CONTROL\n</code></pre> <p>\u8fd9\u91cc\u6bcf\u4e2a broker \u5f00\u653e\u4e86 3 \u4e2a\u76d1\u542c\u7aef\u53e3\uff0c\u4ee5 kafka1 \u8282\u70b9\u4e3a\u4f8b\uff1a</p> <ol> <li>BROKER_DATA: 9090 \u7528\u4e8e broker \u5185\u90e8\u6570\u636e\u4ea4\u4e92\uff0c\u6ce8\u518c\u5730\u5740\u662f <code>kafka1:9090</code>\uff0c<code>kafka1</code> \u4e5f\u53ef\u4ee5\u7528 kafka1 \u8282\u70b9\u7684\u5185\u7f51 ip</li> <li>BROKER_CONTROL: 9091 \u7528\u4e8e controller \u8bf7\u6c42\uff0c\u6ce8\u518c\u5730\u5740\u662f <code>kafka1:9091</code>\uff0c<code>kafka1</code> \u4e5f\u53ef\u4ee5\u7528 kafka1 \u8282\u70b9\u7684\u5185\u7f51 ip</li> <li>EXT_CLIENT: 9092 \u7528\u4e8e\u5916\u7f51\u5ba2\u6237\u7aef\u8bf7\u6c42\uff0c\u6ce8\u518c\u5730\u5740\u662f <code>106.75.143.227:9092</code>\uff0c\u8fd9\u91cc\u76f4\u63a5\u6ce8\u518c\u4ee3\u7406\u5730\u5740\u3002\u540c\u6837\u5730\uff0c\u4e4b\u540e\u4f1a\u7528\u540c\u4e00\u4e2a\u4e3b\u673a\u7684 nginx \u4ee3\u7406\u6240\u6709 kafka broker\uff0c\u6240\u4ee5\u9700\u8981\u4f7f\u7528\u7aef\u53e3\u533a\u5206\u4e0d\u540c broker\uff0c\u6bcf\u4e2a broker EXT_CLIENT \u914d\u7f6e\u7684\u7aef\u53e3\u9700\u8981\u4e0d\u540c\uff0c\u5982\u679c\u53ef\u4ee5\u505a\u5230 nginx \u4ee3\u7406\u673a\u5668\u548c kafka broker \u6570\u91cf\u4e00\u81f4\uff0c\u5219 EXT_CLIENT \u7aef\u53e3\u53ef\u4ee5\u548c\u5176\u4ed6 broker \u76f8\u540c\u3002</li> </ol>","tags":["kafka","proxy"]},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-proxy/#nginx_1","title":"\u914d\u7f6e nginx \u4ee3\u7406","text":"<p>\u4e0e\u65b9\u6cd5 1 \u7684 nginx \u914d\u7f6e\u76f8\u540c\u3002</p>","tags":["kafka","proxy"]},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-proxy/#_3","title":"\u914d\u7f6e\u5ba2\u6237\u7aef\u673a\u5668","text":"<p>\u4e0d\u9700\u8981\u8fdb\u884c\u989d\u5916\u914d\u7f6e\u3002</p>","tags":["kafka","proxy"]},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-reassign-partition-throttle/","title":"2.4 \u8fc1\u79fb\u5206\u533a\u6570\u636e\u9650\u6d41","text":""},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-reassign-partition-throttle/#_1","title":"\u8fc1\u79fb\u8ba1\u5212\u63cf\u8ff0","text":"<p>\u5047\u8bbe\u6709\u8fc1\u79fb\u8ba1\u5212\uff1a</p> <pre><code>t0, p0: 101, 102 -&gt; 102, 103                 101 -&gt; 103\nt0, p1: 102, 103 -&gt; 103, 104                 102 -&gt; 104\nt0, p2: 103, 101 -&gt; 104, 101                 103 -&gt; 104\nt1, p0: 101, 102, 103 -&gt; 102, 103, 104       101 -&gt; 104\n</code></pre> <p>\u6839\u636e\u8fc1\u79fb\u8ba1\u5212\u83b7\u53d6\u6dfb\u52a0 leader \u9650\u5236\u7684\u526f\u672c</p> topic partition broker leader t0 p0 101 \u221a t0 p0 102 t0 p1 102 \u221a t0 p1 103 t0 p2 103 \u221a t0 p2 101 t1 p0 101 \u221a t1 p0 102 t1 p0 103 <p>\u6839\u636e\u8fc1\u79fb\u8ba1\u5212\u83b7\u53d6\u6dfb\u52a0 follower \u9650\u5236\u7684\u526f\u672c</p> topic partition broker t0 p0 103 t0 p1 104 t0 p2 104 t1 p0 104"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-reassign-partition-throttle/#_2","title":"\u9650\u6d41\u6700\u5c0f\u503c\u8ba1\u7b97","text":"<ul> <li>leader \u6d41\u91cf\u9650\u5236\uff1a\u5bf9\u6bcf\u4e2a broker\uff0c\u53ef\u4ee5\u6839\u636e\u91cd\u65b0\u5206\u914d\u5206\u533a\u65b9\u6848\uff0c\u83b7\u53d6\u8be5 broker \u4e0a\u6d89\u53ca\u5230\u7684 topic partition leader \u5199\u5165\u6d41\u91cf\u4e4b\u548c\uff0cbroker \u63d0\u4f9b\u7684 fetch \u8bf7\u6c42\u54cd\u5e94\u6d41\u91cf\u5fc5\u987b\u5927\u4e8e\u5199\u5165\u6d41\u91cf\uff0c\u56e0\u6b64\u8bbe\u7f6e\u8be5 broker \u7684 <code>leader.replication.throttled.rate</code> \u5927\u4e8e\u8fd9\u4e2a\u503c\u3002</li> <li>follower \u6d41\u91cf\u9650\u5236\uff1a\u5bf9\u6bcf\u4e2a broker\uff0c\u53ef\u4ee5\u6839\u636e\u91cd\u65b0\u5206\u914d\u5206\u533a\u65b9\u6848\uff0c\u83b7\u53d6\u8be5 broker \u4e0a\u65b0\u589e\u7684 topic partition\uff0c\u8fdb\u4e00\u6b65\u83b7\u53d6\u8fd9\u4e9b topic partition \u5728\u5f53\u524d leader \u8282\u70b9\u5199\u5165\u6d41\u91cf\u4e4b\u548c\uff0cbroker \u7684 fetch \u8bf7\u6c42\u6d41\u91cf\u5fc5\u987b\u5927\u4e8e\u5199\u5165\u6d41\u91cf\uff0c\u56e0\u6b64\u8bbe\u7f6e\u8be5 broker \u7684 <code>follower.replication.throttled.rate</code> \u5927\u4e8e\u8fd9\u4e2a\u503c\u3002</li> </ul> <pre><code># \u5f53\u524d\u5206\u533a\u5206\u5e03\ncurrent_assignments = [\n    {\n        \"topic\": \"t0\",\n        \"partition\": 0,\n        \"replicas\": [\n            101,\n            102\n        ]\n    },\n    {\n        \"topic\": \"t0\",\n        \"partition\": 1,\n        \"replicas\": [\n            102,\n            103\n        ]\n    },\n    {\n        \"topic\": \"t0\",\n        \"partition\": 2,\n        \"replicas\": [\n            103,\n            101\n        ]\n    },\n    {\n        \"topic\": \"t1\",\n        \"partition\": 0,\n        \"replicas\": [\n            101,\n            102,\n            103\n        ]\n    }\n]\n\n# \u76ee\u6807\u5206\u533a\u5206\u5e03\nproposed_assignments = [\n    {\n        \"topic\": \"t0\",\n        \"partition\": 0,\n        \"replicas\": [\n            102,\n            103\n        ]\n    },\n    {\n        \"topic\": \"t0\",\n        \"partition\": 1,\n        \"replicas\": [\n            103,\n            104\n        ]\n    },\n    {\n        \"topic\": \"t0\",\n        \"partition\": 2,\n        \"replicas\": [\n            104,\n            101\n        ]\n    },\n    {\n        \"topic\": \"t1\",\n        \"partition\": 0,\n        \"replicas\": [\n            102,\n            103,\n            104\n        ]\n    }\n]\n\n\ndef get_traffic(broker, topic, partition):\n    # \u4ece bcm \u83b7\u53d6\u6d41\u91cf\u503c\n    return 1\n\n\n# \u83b7\u53d6 topic partition leader \u5f53\u524d\u5206\u5e03\ntopic_partition_leader = {}\n\n# \u83b7\u53d6\u5f53\u524d\u6bcf\u4e2a broker \u4e0a\u7684 topic partition \u5206\u5e03\ncurrent_distribution = {}\n\ncurrent_distribution_map = {}\n\nfor partition_assign in current_assignments:\n    topic = partition_assign[\"topic\"]\n    partition = partition_assign[\"partition\"]\n    replicas = partition_assign[\"replicas\"]\n\n    # topic partition \u6700\u4f18 leader \u4e3a replicas \u7b2c\u4e00\u4e2a\u503c\n    topic_partition_leader.setdefault(topic, {})[partition] = replicas[0]\n\n    for replica in replicas:\n        current_distribution.setdefault(replica, {}).setdefault(topic, []).append(partition)\n\n    current_distribution_map.setdefault(topic, {})[partition] = replicas\n\n\n# \u83b7\u53d6\u8fc1\u79fb\u540e\uff0c\u6bcf\u4e2a broker \u4e0a\u7684 topic partition \u5206\u5e03\nproposed_distribution = {}\n\nproposed_distribution_map = {}\n\nfor partition_assign in proposed_assignments:\n    topic = partition_assign[\"topic\"]\n    partition = partition_assign[\"partition\"]\n    replicas = partition_assign[\"replicas\"]\n\n    for replica in replicas:\n        proposed_distribution.setdefault(replica, {}).setdefault(topic, []).append(partition)\n\n    proposed_distribution_map.setdefault(topic, {})[partition] = replicas\n\n# \u83b7\u53d6\u6bcf\u4e2a broker \u4e0a\u5c06\u8981\u589e\u52a0\u7684 topic partition\nadd_partitions = {}\n\n# \u83b7\u53d6\u6bcf\u4e2a broker \u4e0a\u5c06\u8981\u5220\u9664\u7684 topic partition\nremove_partitions = {}\n\nfor broker in proposed_distribution.keys() | current_distribution.keys():\n    current_topic_partitions = current_distribution.get(broker, {})\n    proposed_topic_partitions = proposed_distribution.get(broker, {})\n\n    for topic in current_topic_partitions.keys() | proposed_topic_partitions.keys():\n        current_partitions = current_topic_partitions.get(topic, [])\n        proposed_partitions = proposed_topic_partitions.get(topic, [])\n\n        remove_partition = list(set(current_partitions) - set(proposed_partitions))\n        if remove_partition:\n            remove_partitions.setdefault(broker, {})[topic] = remove_partition\n\n        add_partition = list(set(proposed_partitions) - set(current_partitions))\n        if add_partition:\n            add_partitions.setdefault(broker, {})[topic] = add_partition\n\n\n# \u91cd\u65b0\u5206\u914d\u5206\u533a\u8fc7\u7a0b\u4e2d\uff0c\u6bcf\u4e2a broker \u4e0a\u7684 topic partition \u5206\u5e03\nin_progress_distribution = {}\n\nfor broker, topic_partitions in current_distribution.items():\n    for topic, partitions in topic_partitions.items():\n        in_progress_distribution.setdefault(broker, {})[topic] = partitions\n        if broker in add_partitions and topic in add_partitions[broker]:\n            in_progress_distribution.setdefault(broker, {})[topic].extend(add_partitions[broker][topic])\n\nin_progress_distribution_map = {}\n\nfor topic, partitions in current_distribution_map.items():\n    for partition, replicas in partitions.items():\n        in_progress_distribution_map.setdefault(topic, {})[partition] = replicas\n        in_progress_distribution_map.[topic][partition].extend(proposed_distribution_map[topic, partition])\n\n# \u8bb0\u5f55 topic partition \u5f53\u524d\u6d41\u91cf\ntopic_partition_in_traffic = {}\n\n# \u805a\u5408\u6bcf\u4e2a broker \u4e0a\u6d89\u53ca\u7684 topic partition leader \u6d41\u5165\u6d41\u91cf\nbroker_leader_in_traffic = {}\n\n# \u805a\u5408\u6bcf\u4e2a broker \u4e0a\u6d89\u53ca\u7684 topic partition leader \u6d41\u51fa\u6d41\u91cf\nbroker_leader_out_traffic = {}\n\nfor broker, topic_partitions in current_distribution.items():\n    for topic, partitions in topic_partitions.items():\n        # \u7406\u60f3\u72b6\u6001\u4e0b\uff0c\u83b7\u53d6 broker - topioc - partition \u7684\u6d41\u91cf BytesInPerSec\n        # for partition in partitions:\n        #     bytes_in_per_sec = get_traffic(broker, topic, partition)\n        #     if broker_leader_in_traffic[broker] is None:\n        #         broker_leader_in_traffic[broker] = 0\n        #     broker_leader_in_traffic[broker] += bytes_in_per_sec\n\n        # \u4f46\u662f\u5b9e\u9645\u53ea\u80fd\u83b7\u53d6\u5230 broker - topic \u7ef4\u5ea6\u7684\u6d41\u91cf BytesInPerSec\n        bytes_in_per_sec = get_traffic(broker, topic, None)\n        if not broker in broker_leader_in_traffic:\n            broker_leader_in_traffic[broker] = 0\n        broker_leader_in_traffic[broker] += bytes_in_per_sec  # broker \u4e0a\u6240\u6709 topic \u5199\u5165\u6d41\u91cf\u4e4b\u548c\n\n        # TODO: \u8981\u63d0\u4f9b\u591a\u5c11\u4e2a\u540c\u6b65\u526f\u672c\uff1f\n        if not broker in broker_leader_out_traffic:\n            broker_leader_out_traffic[broker] = 0\n        broker_leader_out_traffic[broker] += bytes_in_per_sec  # broker \u4e0a\u6240\u6709 topic \u5199\u5165\u6d41\u91cf\u4e4b\u548c\n\n        # \u8bb0\u5f55\u5f53\u524d topic partition \u5728 leader \u8282\u70b9\u6d41\u91cf\n        # \u95ee\u9898\uff1a\n        #   1. \u5f53\u524d\u8282\u70b9\u662f\u5426\u4e3a partition leader \uff1f\u5176\u5b9e\u4e0d\u662f\u95ee\u9898\uff0c\u53ea\u6709\u662f partition leader \u7684\u60c5\u51b5\u4e0b\u624d\u80fd\u83b7\u53d6\u5230\u6d41\u91cf\uff0c\u4e0d\u662f\u7684\u8bdd\u6d41\u91cf\u4e3a 0\n        #   2. \u904d\u5386\u6bcf\u4e2a\u526f\u672c\uff0c\u610f\u5473\u7740\u4e0d\u80fd\u7b80\u5355\u7684\u6c42\u548c\uff0c\u7406\u60f3\u60c5\u51b5\u4e0b\uff0c\u53ea\u6709\u4e00\u4e2a\u526f\u672c\u6709\u503c\uff0c\u5176\u4ed6\u526f\u672c\u90fd\u4e3a 0\n        #   3. \u5982\u679c\u6c42\u5386\u53f2\u6d41\u91cf\u7684\u503c\uff0c\u53ef\u80fd\u53d1\u751f leader \u5207\u6362\uff0c\u53ef\u80fd\u6709\u591a\u4e2a\u526f\u672c\u6709\u503c\uff0c\u6240\u4ee5\u8fd9\u91cc\u6c42\u6700\u5927\u503c\n        #   4. \u65e0\u6cd5\u53d6\u5f97 partition \u7ea7\u522b\u7684\u6d41\u91cf\uff0c\u53ea\u80fd\u4ee5 topic \u7ea7\u522b\u4ee3\u66ff\u3002\u5982\u679c\u4e00\u4e2a broker \u4e0a\u6709\u591a\u4e2a partition leader\uff0c\u4f1a\u5bfc\u81f4\u5f97\u5230\u7684\u5206\u533a\u6d41\u91cf\u504f\u5927\n        if not topic in topic_partition_in_traffic:\n            topic_partition_in_traffic[topic] = {}\n\n        for partition in partitions:\n            traffic = topic_partition_in_traffic[topic].get(partition, 0)\n            topic_partition_in_traffic[topic][partition] = max(bytes_in_per_sec, traffic)\n\n\n\n# \u8ba1\u7b97 follower \u9700\u8981\u6d41\u91cf\n# \u8fd9\u90e8\u5206\u4e3b\u8981\u770b\u54ea\u4e9b\u8282\u70b9\u6709\u65b0\u589e\u7684 partition\nbroker_follower_traffic = {}\nfor broker, topic_partitions in add_partitions.items():\n    for topic, partitions in topic_partitions.items():\n        # \u5728 broker \u4e0a\u589e\u52a0 topic partition\n        # \u9700\u8981\u83b7\u53d6\u8fd9\u4e2a topic partition leader \u5f53\u524d\u7684\u6d41\u91cf\n\n        # \u7406\u60f3\u72b6\u6001\u4e0b\uff0c\u83b7\u53d6 broker - topioc - partition \u7684\u6d41\u91cf\n        # \u4f46\u662f\u53ea\u80fd\u83b7\u53d6\u5230 broker -topic \u7ef4\u5ea6\u7684\u6d41\u91cf BytesInPerSec\uff0c\u4f1a\u4f7f\u5f97\u8fd9\u91cc\u6d41\u91cf\u504f\u5927\n        for partition in partitions:\n            leader_bytes_in_per_sec = topic_partition_in_traffic[topic][partition]\n\n            # \u5206\u533a\u526f\u672c\u7684\u540c\u6b65\u901f\u7387\u5927\u4e8e leader \u7684\u5199\u5165\u901f\u7387\n            if not broker in broker_follower_traffic:\n                broker_follower_traffic[broker] = 0\n            broker_follower_traffic[broker] += leader_bytes_in_per_sec\n\n\nthrottle = -1\n\nfor broker, traffic in broker_leader_in_traffic.items():\n    if traffic &gt; throttle:\n        throttle = traffic\n\nfor broker, traffic in broker_follower_traffic.items():\n    if traffic &gt; throttle:\n        throttle = traffic\n</code></pre> <p>\u95ee\u9898\uff1a</p> <ul> <li>kafka JMX \u4e0d\u63d0\u4f9b topic partition \u7ea7\u522b\u7684\u6d41\u91cf\u76d1\u63a7</li> <li>\u91cd\u5206\u533a\u8fc7\u7a0b\u4e2d\uff0c\u53d1\u751f leader \u5207\u6362\uff0c\u53ef\u80fd\u5bfc\u81f4\u539f\u6765\u8bbe\u7f6e\u7684\u6d41\u91cf\u9650\u5236\u5c0f\u4e8e\u8be5\u8282\u70b9 leader \u5199\u5165\u901f\u7387</li> <li>\u5206\u6279\u6267\u884c\uff0c\u4f1a\u4f7f\u5f97\u6bcf\u4e2a\u6279\u6b21\u9700\u8981\u7684\u5b9e\u9645\u6d41\u91cf\u66f4\u5c0f</li> <li>\u751f\u6210\u91cd\u5206\u533a\u65b9\u6848\u6709\u968f\u673a\u6027\uff0c\u610f\u5473\u7740\u9884\u4f30\u4f9d\u636e\u7684\u65b9\u6848\u5fc5\u987b\u4e0e\u5b9e\u9645\u6267\u884c\u7684\u65b9\u6848\u4e00\u81f4</li> </ul>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-reassign-partition-throttle/#_3","title":"\u8fc1\u79fb\u8017\u65f6\u9884\u4f30","text":"<pre><code>def get_log_size(broker, topic, partition):\n    # \u4ece bcm \u83b7\u53d6 topic, partition \u5360\u7528\u5927\u5c0f\n    return 1\n\n# \u83b7\u53d6\u8981\u79fb\u52a8\u7684 topic partition log size\ntopic_partition_log_size = {}\nfor broker, topic_partitions in remove_partitions.items():\n    for topic, partitions in topic_partitions.items():\n        for partition in partitions:\n            topic_partition_log_size.setdefault(topic, {})[partition] = get_log_size(broker, topic, partition)\n\n# leader \u8282\u70b9\u9700\u8981\u63d0\u4f9b\u8fd9\u4e9b topic partition \u7684 fetch \u6d41\u91cf\nbroker_leader_log_size = {}\n\n# follower \u8282\u70b9\u9700\u8981\u65b0\u589e\u8fd9\u4e9b topic partition\nbroker_follower_log_size = {}\n\nfor broker, topic_partitions in add_partitions.items():\n    for topic, partitions in topic_partitions.items():\n        for partition in partitions:\n            log_size = topic_partition_log_size[topic][partition]\n\n            if not broker in broker_follower_log_size:\n                broker_follower_log_size[broker] = 0\n            broker_follower_log_size[broker] += log_size\n\n            # leader \u8282\u70b9\u9700\u8981\u88ab\u590d\u5236\u7684 topic partition\n            # \u8fd9\u91cc\u8ba4\u4e3a\u6700\u4f18 leader \u4e3a\u5f53\u524d leader\uff0c\u4f46\u5b9e\u9645\u60c5\u51b5\u53ef\u80fd\u4e0d\u540c\n            leader = topic_partition_leader[topic][partition]\n\n            if not broker in broker_leader_log_size:\n                broker_leader_log_size[leader] = 0\n            broker_leader_log_size[leader] += log_size\n\n# \u83b7\u53d6\u8fc1\u79fb\u8017\u65f6\nmax_duration = 0\n\n# \u9608\u503c\u4e0d\u80fd\u8bbe\u7f6e\u4e3a\u6700\u5c0f\u503c\uff0c\u8fd9\u91cc\u589e\u52a0 20%\nthrottle = throttle * 1.2\n\n# leader \u8017\u65f6\nfor broker, log_size in broker_leader_log_size.items():\n    traffic = broker_leader_in_traffic[broker]\n    duration = log_size / (throttle - traffic)\n    if duration &gt; max_duration:\n        max_duration = duration\n\n# follower \u8017\u65f6\nfor broker, log_size in broker_follower_log_size.items():\n    traffic = broker_follower_traffic[broker]\n    duration = log_size / (throttle - traffic)\n    if duration &gt; max_duration:\n        max_duration = duration\n</code></pre> <p>\u95ee\u9898\uff1a</p> <ul> <li>\u8fd9\u91cc\u662f\u9650\u6d41\uff0c\u4f46\u4e0d\u4ee3\u8868\u5b9e\u9645\u7684\u8fc1\u79fb\u6d41\u91cf\u548c\u9650\u6d41\u4e00\u6837</li> <li>\u5206\u6279\u6267\u884c\uff0c\u5e76\u884c\u5ea6\u4e0b\u964d\uff0c\u4f1a\u5bfc\u81f4\u8fc1\u79fb\u65f6\u957f\u589e\u52a0</li> </ul>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-reassign-partitions/","title":"\u5206\u533a\u91cd\u5206\u914d/\u4fee\u6539\u526f\u672c\u6570","text":"<p>Kafka \u5728\u9010\u6b65\u53bb\u9664 zookeeper \u4f9d\u8d56\uff0c\u6240\u4ee5\u4e0d\u540c\u7684\u7248\u672c\u547d\u4ee4\u884c\u5de5\u5177\u53c2\u6570\u5b58\u5728\u5dee\u5f02\uff0c \u4ee5\u4e0b\u5927\u90e8\u5206\u547d\u4ee4\u7ed9\u4e86\u4f9d\u8d56 zookeeper \u548c\u4e0d\u4f9d\u8d56 zookeeper \u7684 2 \u79cd\u793a\u4f8b\uff0c\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684 kafka \u7248\u672c\u8fdb\u884c\u9009\u62e9\u3002</p>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-reassign-partitions/#_2","title":"\u9884\u8bbe\u73af\u5883\u53d8\u91cf","text":"<p>\u9884\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\uff0c\u65b9\u4fbf\u64cd\u4f5c\uff1a</p> <pre><code># \u5c06 kafka \u547d\u4ee4\u811a\u672c\u8def\u5f84\u52a0\u5165\u5230 PATH\nexport KAFKA_HOME=/usr/local/kafka\nexport PATH=\"$PATH:${KAFKA_HOME}/bin\"\n\n# zk \u8fde\u63a5\u5730\u5740\nexport ZK_CONNECT=\"$(hostname):2181\"\n\n# kafka \u8fde\u63a5\u5730\u5740\nexport BOOTSTRAP_SERVER=\"$(hostname):9092\"\n\n# \u5982\u679c\u6709 jaas \u8ba4\u8bc1\nexport KAFKA_OPTS=\"-Djava.security.auth.login.config=${KAFKA_HOME}/config/kafka_server_jaas.conf\"\n\n# \u5982\u679c broker \u901a\u8fc7\u5728 kafka-run-class.sh \u6587\u4ef6\u5185\u8bbe\u7f6e JMX_PORT\uff0c\u5219\u8fd9\u91cc\u9700\u8981\u8bbe\u7f6e\u6210\u4e0d\u540c\u7684 port\n# (\u4e00\u822c broker \u5f00\u542f JMX_PORT \u6700\u597d\u5728 kafka-server-start.sh \u6587\u4ef6\u5185\u8bbe\u7f6e\uff0ckafka-run-class.sh \u6587\u4ef6\u5185\u7684\u4fee\u6539\u4f1a\u5f71\u54cd\u5230\u6240\u6709\u547d\u4ee4\u811a\u672c)\n# export JMX_PORT=9997\n</code></pre>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-reassign-partitions/#broker-id","title":"\u83b7\u53d6\u5f53\u524d\u96c6\u7fa4 broker id \u5217\u8868","text":"<p>\u83b7\u53d6\u5f53\u524d broker id \u5217\u8868\uff1a</p> <pre><code>$ zookeeper-shell.sh ${ZK_CONNECT} ls /brokers/ids | sed 's/ //g'\n</code></pre>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-reassign-partitions/#_3","title":"\u751f\u6210\u5206\u914d\u65b9\u6848","text":"<p>\u521b\u5efa <code>topics.json</code> \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u4e3a\u9700\u8981\u91cd\u5206\u533a\u7684 topic\uff0c\u4f8b\u5982\uff1a</p> <pre><code>{\n    \"topics\": [\n        {\n            \"topic\": \"statistics\"\n        }\n    ],\n    \"version\": 1\n}\n</code></pre> <p>\u6267\u884c <code>kafka-reassign-partitions.sh</code>\uff0c\u6307\u5b9a <code>--generate</code> \u53c2\u6570\u548c\u521a\u624d\u521b\u5efa\u7684 <code>topics.json</code> \u6587\u4ef6\uff0c\u901a\u8fc7 <code>--broker-list</code> \u6307\u5b9a\u5206\u5e03\u7684 broker id\uff0c\u751f\u6210\u63cf\u8ff0 partition \u5206\u5e03\u7684\u5185\u5bb9\uff1a</p> <pre><code>$ kafka-reassign-partitions.sh --zookeeper ${ZK_CONNECT} --generate --topics-to-move-json-file topics.json --broker-list 1,2,3 | tee plan\n\n$ kafka-reassign-partitions.sh --bootstrap-server ${BOOTSTRAP_SERVER} --topics-to-move-json-file topics.json --broker-list 1,2,3 --generate | tee plan\n</code></pre> <p>\u547d\u4ee4\u4f1a\u7ed9\u51fa\u73b0\u5728\u7684 partition \u5206\u5e03\u548c\u76ee\u7684 partition \u5206\u5e03\uff0c\u5c06\u751f\u6210\u7684\u5185\u5bb9\u5206\u522b\u4fdd\u5b58\u5230 <code>current.json</code>(\u7528\u4e8e\u6062\u590d) <code>reassign.json</code>(\u4e4b\u540e\u7684\u8ba1\u5212)</p> <pre><code>$ sed -n '2p' plan &gt; current.json\n\n$ sed -n '5p' plan &gt; reassign.json\n</code></pre> <p>\u53ef\u4ee5\u8c03\u6574 <code>replicas.json</code> \u7684\u5185\u5bb9\uff0c<code>replicas</code> \u5b57\u6bb5\u7684\u542b\u4e49\u662f\u8be5 partition \u5206\u5e03\u7684 broker id\uff1a</p> <ol> <li>\u901a\u8fc7\u589e\u52a0/\u51cf\u5c11 <code>replicas</code> \u4e2d\u7684 broker id \u53ef\u4ee5\u589e\u52a0/\u51cf\u5c11\u526f\u672c\uff08<code>log_dirs</code> \u5305\u542b\u7684\u9879\u8981\u4e0e <code>replicas</code> \u5305\u542b\u7684\u9879\u6570\u76ee\u4e00\u81f4\uff09</li> <li>\u8c03\u6574 <code>replicas</code> \u5b57\u6bb5\u7684\u7b2c\u4e00\u4e2a broker id \u53ef\u4ee5\u6307\u5b9a\u8fd9\u4e2a partition \u7684\u4f18\u5148 leader</li> <li>\u901a\u8fc7\u6307\u5b9a <code>log_dirs</code> \u4e2d <code>any</code> \u4e3a\u5b9e\u9645\u7684\u76ee\u5f55\uff0c\u4ece\u800c\u6307\u5b9a\u5206\u533a\u6570\u636e\u4f4d\u7f6e\uff08<code>log.dirs</code> \u914d\u7f6e\u7684\u76ee\u5f55\uff09</li> </ol> <pre><code>{\n    \"partitions\": [\n        {\n            \"log_dirs\": [\n                \"any\", \"any\", \"any\"\n            ],\n            \"partition\": 0,\n            \"replicas\": [\n                1, 2, 3\n            ],\n            \"topic\": \"statistics\"\n        }\n    ],\n    \"version\": 1\n}\n</code></pre> <p>\u7248\u672c\u4f4e\u4e8e 1.1.0\uff0c\u5206\u914d\u65b9\u6848\u6ca1\u6709 <code>log_dirs</code> \u5b57\u6bb5\uff0c\u53ef\u4ee5\u5ffd\u7565</p>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-reassign-partitions/#_4","title":"\u6267\u884c\u91cd\u65b0\u5206\u914d","text":"<p>\u6267\u884c <code>kafka-reassign-partitions.sh</code>\uff0c\u6307\u5b9a <code>--execute</code> \u53c2\u6570\u548c <code>reassign.json</code> \u6587\u4ef6\uff0c\u6267\u884c partition \u91cd\u5206\u5e03\uff1a</p> <pre><code>$ kafka-reassign-partitions.sh --zookeeper ${ZK_CONNECT} --execute --reassignment-json-file reassign.json\n\n$ kafka-reassign-partitions.sh --bootstrap-server ${BOOTSTRAP_SERVER} --reassignment-json-file reassign.json --execute\n</code></pre> <p>\u6267\u884c <code>kafka-reassign-partitions.sh</code>\uff0c\u6307\u5b9a <code>--verify</code> \u53c2\u6570\u548c <code>reassign.json</code> \u6587\u4ef6\uff0c\u786e\u8ba4 partition \u91cd\u5206\u5e03\u8fdb\u5ea6\uff1a</p> <pre><code>$ kafka-reassign-partitions.sh --zookeeper ${ZK_CONNECT} --verify --reassignment-json-file reassign.json\n\n$ kafka-reassign-partitions.sh --bootstrap-server ${BOOTSTRAP_SERVER} --reassignment-json-file reassign.json --verify\n</code></pre> <p>\u6267\u884c <code>kafka-reassign-partitions.sh</code>\uff0c\u6307\u5b9a <code>--list</code> \u53c2\u6570\uff0c\u67e5\u770b\u5f53\u524d\u6b63\u5728\u8fdb\u884c\u91cd\u5206\u914d\u7684\u5206\u533a\uff1a</p> <pre><code>$ kafka-reassign-partitions.sh --bootstrap-server ${BOOTSTRAP_SERVER} --list\nCurrent partition reassignments:\ntest-0: replicas: 2,1,3. adding: 1. removing: 3.\ntest-1: replicas: 3,2,1. adding: 2. removing: 1.\ntest-2: replicas: 1,3,2. adding: 3. removing: 2.\n</code></pre> <p>\u53d6\u6d88\u91cd\u5206\u914d\uff1a</p> <pre><code>$ kafka-reassign-partitions.sh --bootstrap-server ${BOOTSTRAP_SERVER} --reassignment-json-file reassign.json --cancel\n</code></pre>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-reassign-partitions/#_5","title":"\u9650\u6d41","text":"<p>\u5982\u679c topic \u6570\u636e\u91cf\u548c\u6d41\u91cf\u8fc7\u5927\uff0c\u91cd\u5206\u533a\u4f1a\u5bf9\u96c6\u7fa4\u670d\u52a1\u9020\u6210\u6bd4\u8f83\u5927\u7684\u5f71\u54cd\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528 <code>--throttle</code> \u53c2\u6570\u5bf9\u91cd\u5206\u533a\u9650\u5236\u6d41\u91cf\uff0c\u5355\u4f4d Byte/s\u3002</p> <p>\u6bd4\u5982\u9650\u5236\u4e0d\u8d85\u8fc7 50MB/s\uff1a</p> <pre><code>$ kafka-reassign-partitions.sh --zookeeper ${ZK_CONNECT} --execute --reassignment-json-file reassign.json --throttle 50000000\n\n$ kafka-reassign-partitions.sh --bootstrap-server ${BOOTSTRAP_SERVER} --reassignment-json-file reassign.json --execute --throttle 50000000\n</code></pre> <p>\u91cd\u65b0\u9650\u5236\u6d41\u91cf\u4e3a 700MB/s</p> <pre><code>$ kafka-reassign-partitions.sh --bootstrap-server ${BOOTSTRAP_SERVER} --reassignment-json-file reassign.json --execute --additional --throttle 700000000\n</code></pre> <p>\u5f53\u5206\u533a\u5206\u914d\u5b8c\u6210\u540e\uff0c\u91cd\u65b0\u6267\u884c verfiy \u4f1a\u53d6\u6d88\u9650\u6d41\u8bbe\u7f6e</p> <pre><code>$ kafka-reassign-partitions.sh --zookeeper ${ZK_CONNECT} --verify --reassignment-json-file reassign.json\n\n$ kafka-reassign-partitions.sh --bootstrap-server ${BOOTSTRAP_SERVER} --verify --reassignment-json-file reassign.json\n</code></pre> <p>\u6d41\u91cf\u9650\u5236\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7\u8c03\u6574\u4ee5\u4e0b\u53c2\u6570\u5b9e\u73b0\uff1a</p> <ul> <li>broker \u7ea7\u522b<ul> <li><code>leader.replication.throttled.rate</code></li> <li><code>follower.replication.throttled.rate</code></li> </ul> </li> <li>topic \u7ea7\u522b<ul> <li><code>leader.replication.throttled.replicas</code></li> <li><code>follower.replication.throttled.replicas</code></li> </ul> </li> </ul> <p>\u67e5\u770b\u53c2\u6570\uff1a</p> <pre><code>$ kafka-configs.sh --describe --bootstrap-server ${BOOTSTRAP_SERVER} --entity-type brokers\n\n$ kafka-configs.sh --describe --bootstrap-server ${BOOTSTRAP_SERVER} --entity-type topics\n</code></pre> <p>\u9650\u6d41\u8bbe\u7f6e\u89c4\u5219\uff1a</p> <ul> <li>\u4e3b\u9898\u91cd\u65b0\u5206\u914d\u5206\u533a\u524d\u6240\u6709\u526f\u672c\u5747\u8bbe\u7f6e leader \u9650\u6d41\uff08\u5176\u4e2d\u4efb\u4f55\u4e00\u4e2a\u526f\u672c\u90fd\u53ef\u80fd\u6210\u4e3a\u5206\u533a leader\uff09</li> <li>\u4e3b\u9898\u91cd\u65b0\u5206\u914d\u5206\u533a\u540e\u65b0\u589e\u7684\u526f\u672c\u5747\u8bbe\u7f6e follower \u9650\u6d41</li> <li>\u5bf9\u6d89\u53ca\u8bbe\u7f6e leader \u9650\u6d41\u7684\u526f\u672c\u6240\u5728\u8282\u70b9\u8bbe\u7f6e <code>leader.replication.throttled.rate</code></li> <li>\u5bf9\u6d89\u53ca\u8bbe\u7f6e follower \u9650\u6d41\u7684\u526f\u672c\u6240\u5728\u8282\u70b9\u8bbe\u7f6e <code>follower.replication.throttled.rate</code></li> </ul> <p>\u4f8b\u5982\uff1aTopic A \u5206\u533a 0 \u526f\u672c\u5206\u5e03\u4ece 101,102 \u5230 102,103\uff0c\u8bbe\u7f6e\u9650\u6d41 2048 B/s\uff0c\u4f1a\u5728 101, 102 \u4e0a\u5e94\u7528 leader \u9650\u6d41\uff0c\u5728 103 \u4e0a\u9650\u5236 follower \u9650\u6d41</p> <p>\u5bf9 Topic A \u8bbe\u7f6e\u914d\u7f6e\uff1a</p> <pre><code>leader.replication.throttled.replicas=0:101,0:102\nfollower.replication.throttled.replicas=0:103\n</code></pre> <p>\u5bf9 broker 101\uff0c102 \u8bbe\u7f6e\u914d\u7f6e\uff1a</p> <pre><code>leader.replication.throttled.rate=2048\n</code></pre> <p>\u5bf9 broker 103 \u8bbe\u7f6e\u914d\u7f6e\uff1a</p> <pre><code>follower.replication.throttled.rate=2048\n</code></pre>"},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-upgrade/","title":"kafka \u6eda\u52a8\u5347\u7ea7","text":"<p>kafka \u6eda\u52a8\u5347\u7ea7\u53c2\u8003\u5b98\u65b9\u6587\u6863\uff0c\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u9700\u8981\u8fdb\u884c\u4e24\u6b21\u6eda\u52a8\u91cd\u542f\u8282\u70b9\u64cd\u4f5c\uff0c\u53ef\u4ee5\u4fdd\u8bc1\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u96c6\u7fa4\u670d\u52a1\u4e0d\u4e2d\u65ad\u3002</p> <p>\u4e0b\u9762\u4ee5 0.9.0.X \u5347\u7ea7\u5230 1.1.1 \u4e3a\u4f8b\uff0c\u5047\u8bbe kafka \u5b89\u88c5\u5728 <code>/usr/local/kafka</code> \u4e0b\uff0c\u5e76\u7528 systemd \u7ba1\u7406\uff1a</p>","tags":["kafka"]},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-upgrade/#_1","title":"\u7b2c\u4e00\u6b65","text":"<p>\u9700\u8981\u4f9d\u6b21\u66ff\u6362\u8282\u70b9 kafka \u5230 1.1.1 \u7248\u672c\uff0c\u66ff\u6362\u8fc7\u7a0b\u4e2d\u4fdd\u7559\u8282\u70b9\u539f\u6709 kafka \u914d\u7f6e\uff0c\u5e76\u65b0\u589e\u914d\u7f6e\u6307\u5b9a <code>inter.broker.protocol.version=0.9.0.X</code>\uff0c<code>log.message.format.version=0.9.0.X</code> \u4e0e\u73b0\u6709\u96c6\u7fa4\u7248\u672c\u517c\u5bb9\uff0c\u5177\u4f53\u64cd\u4f5c\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <pre><code># \u4e0b\u8f7d 1.1.1 \u7248\u672c kafka\nwget https://archive.apache.org/dist/kafka/1.1.1/kafka_2.12-1.1.1.tgz -O /tmp/kafka_2.12-1.1.1.tgz\nwget https://archive.apache.org/dist/kafka/1.1.1/kafka_2.12-1.1.1.tgz.sha512 -O /tmp/kafka_2.12-1.1.1.tgz.sha512\n\n# \u6821\u9a8c kafka \u5305\n# cd /tmp\n# [[ `md5sum kafka_1.1.1.tar.gz` == `cat kafka_1.1.1.md` ]] &amp;&amp; echo 'ok' || echo 'no'\n# [[ `shasum -a512 kafka_2.12-1.1.1.tgz` == `cat kafka_2.12-1.1.1.tgz.sha512` ]] &amp;&amp; echo 'ok' || echo 'no'\n# [[ `openssl sha512 kafka_2.12-1.1.1.tgz` == `cat kafka_2.12-1.1.1.tgz.sha512` ]] &amp;&amp; echo 'ok' || echo 'no'\n\n# \u6821\u9a8c\u6210\u529f\u540e\u89e3\u538b kafka \u5305\ntar -zxvf /tmp/kafka_2.12-1.1.1.tgz -C /tmp\n\n# \u4fdd\u7559\u539f\u6709\u914d\u7f6e\nmv /tmp/kafka/config /tmp/kafka/config.back\ncp -r /usr/local/kafka/config /tmp/kafka/\n\n# \u6307\u5b9a\u901a\u4fe1\u534f\u8bae\u4e0e\u6d88\u606f\u683c\u5f0f\necho inter.broker.protocol.version=0.9.0.X &gt;&gt; /tmp/kafka/config/server.properties\necho log.message.format.version=0.9.0.X &gt;&gt; /tmp/kafka/config/server.properties\n\n# \u66ff\u6362 kafka \u5305\nmv /usr/local/kafka /usr/local/kafka.back\ncp -r /tmp/kafka /usr/local/\n\n# \u91cd\u542f kafka \u8282\u70b9\n# service kafka-server restart\nsystemctl restart kafka\n</code></pre>","tags":["kafka"]},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-upgrade/#_2","title":"\u7b2c\u4e8c\u6b65","text":"<p>Kafka \u7248\u672c\u5347\u7ea7\u6709\u901a\u4fe1\u534f\u8bae\u548c\u6d88\u606f\u683c\u5f0f\u7684\u53d8\u5316\uff0c\u7ecf\u8fc7\u4e0a\u4e00\u6b65\u7684\u66ff\u6362\uff0c\u96c6\u7fa4\u4e0a\u7684 kafka \u5305\u5df2\u7ecf\u66ff\u6362\u6210 1.1.1 \u7248\u672c\uff0c\u901a\u4fe1\u534f\u8bae\u548c\u6d88\u606f\u683c\u5f0f\u4ecd\u7136\u6307\u5b9a\u4e3a 0.9.0.X \u7248\u672c\uff0c\u4e4b\u540e\u9700\u8981\u5bf9\u8fd9\u4e24\u9879\u914d\u7f6e\u8fdb\u884c\u66f4\u65b0\uff0c\u4f46\u9700\u8981\u6ce8\u610f\u4ee5\u4e0b\u4e24\u70b9\uff1a</p> <ol> <li>\u66f4\u6539 <code>log.message.format.version</code> \u4e4b\u524d\uff0c\u6240\u6709\u6d88\u8d39\u8005\u5fc5\u987b\u5347\u7ea7\u5230\u652f\u6301 1.1.1 \u6216\u8005\u4e4b\u540e\u7684\u7248\u672c</li> <li><code>inter.broker.protocol.version</code>, <code>log.message.format.version</code> \u66f4\u6539\u5e76\u91cd\u542f\u751f\u6548\u4e4b\u540e\uff0ckafka \u7248\u672c\u4e0d\u80fd\u8fdb\u884c\u964d\u7ea7\u56de\u9000</li> </ol> <p>\u64cd\u4f5c\u6b65\u9aa4\uff1a</p> <pre><code># \u6307\u5b9a\u901a\u4fe1\u534f\u8bae\u4e0e\u6d88\u606f\u683c\u5f0f\nsed -i \"s/inter.broker.protocol.version=0.9.0.X/inter.broker.protocol.version=1.1-IV0/g\" /usr/local/kafka/config/server.properties\nsed -i \"s/log.message.format.version=0.9.0.X/log.message.format.version=1.1-IV0/g\" /usr/local/kafka/config/server.properties\n\n# \u91cd\u542f kafka \u8282\u70b9\n# service kafka-server restart\nsystemctl restart kafka\n</code></pre>","tags":["kafka"]},{"location":"2-%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C/kafka-upgrade/#_3","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>0.10.0.0 \u4e4b\u540e\u6d88\u606f\u683c\u5f0f\u6539\u53d8\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u7248\u672c\u4f4e\u4e8e 0.10.0.0 \u4f1a\u5e26\u6765\u6027\u80fd\u635f\u5931</li> </ul>","tags":["kafka"]},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/","title":"kafka \u5e38\u7528\u914d\u7f6e\u53c2\u6570","text":""},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/0-os-config/","title":"OS","text":""},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/0-os-config/#_1","title":"\u6587\u4ef6\u63cf\u8ff0\u7b26\u9650\u5236","text":"<p>\u6bcf\u4e2a broker \u81f3\u5c11\u9700\u8981\u521b\u5efa number_of_partitions * (partition_size / segment_size) \u4e2a segment \u6587\u4ef6\u3002</p> <p>\u63a8\u8350\u6587\u4ef6\u6570\u9650\u5236\u6700\u5c11\u4e3a 100000</p> <p>\u4fee\u6539 <code>/etc/security/limits.conf</code> \u6587\u4ef6</p> <pre><code>#&lt;domain&gt;  &lt;type&gt;  &lt;item&gt;  &lt;value&gt;\n\n# root \u7528\u6237\u9650\u5236\u6587\u4ef6\u6570\u9650\u5236 100000\nroot soft nofile 100000\nroot hard nofile 100000\n\n# \u5176\u4ed6\u7528\u6237\u9650\u5236\u6587\u4ef6\u6570\u9650\u5236 100000\n*    soft nofile 65535\n*    hard nofile 65535\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/0-os-config/#socket-buffer","title":"socket buffer","text":"<p>\u4fee\u6539 <code>/etc/sysctl.conf</code> \u6587\u4ef6</p> <pre><code># \u5355\u4e2a socket buffer \u7684\u6700\u5927\u5185\u5b58\u9650\u5236\nnet.core.optmem_max = 33554432\n\n# \u5355\u4e2a socket receive buffer \u9ed8\u8ba4\u5185\u5b58\u9650\u5236\nnet.core.rmem_default = 33554432\n\n# \u5355\u4e2a socket receive buffer \u6700\u5927\u5185\u5b58\u9650\u5236\nnet.core.rmem_max = 67108864\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/0-os-config/#vmmax_map_count","title":"vm.max_map_count","text":"<p>\u6bcf\u4e2a segment \u6587\u4ef6\u5bf9\u5e94\u4e00\u5bf9 index/timeindex \u6587\u4ef6\uff0c\u6bcf\u4e2a index/timeindex \u6587\u4ef6\u6d88\u8017\u4e00\u4e2a map \u533a\u57df</p> <p>\u9700\u8981\u786e\u4fdd\u6709\u8db3\u591f\u7684\u865a\u62df\u5185\u5b58\u53ef\u7528\u4e8e <code>mmapped</code> \u6587\u4ef6</p> <p>\u4fee\u6539 <code>/etc/sysctl.conf</code> \u6587\u4ef6</p> <pre><code>vm.max_map_count=262144\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/0-os-config/#_2","title":"\u53c2\u8003","text":"<ul> <li>https://kafka.apache.org/27/documentation.html#hwandos</li> <li>https://developer.confluent.io/learn/kafka-performance/</li> </ul>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/1-jvm-config/","title":"JVM","text":"<pre><code>-Xmx6g -Xms6g \\\n-XX:MetaspaceSize=96m \\\n-XX:+UseG1GC \\\n-XX:MaxGCPauseMillis=20 \\\n-XX:InitiatingHeapOccupancyPercent=35 \\\n-XX:G1HeapRegionSize=16M \\\n-XX:MinMetaspaceFreeRatio=50 \\\n-XX:MaxMetaspaceFreeRatio=80 \\\n-XX:+ExplicitGCInvokesConcurrent\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/1-jvm-config/#g1","title":"\u4f7f\u7528 G1 \u5783\u573e\u56de\u6536\u5668","text":"<pre><code>-XX:+UseG1GC\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/1-jvm-config/#_1","title":"\u5806\u5185\u5b58","text":"<p>kafka \u5e76\u4e0d\u9700\u8981\u8fc7\u9ad8\u7684\u5806\u5185\u5b58\uff0c\u4e00\u822c\u5806\u5185\u5b58\u7684\u5927\u5c0f\u4e0d\u9700\u8981\u8d85\u8fc7 6G\u3002</p> <pre><code>KAFKA_HEAP_OPTS='-Xmx6G -Xms6G'\n</code></pre> <p>\u76f8\u53cd\uff0ckafka \u6027\u80fd\u4e0e\u6587\u4ef6\u8bfb\u5199\u6027\u80fd\u76f4\u63a5\u76f8\u5173\uff0c\u8fd9\u8981\u6c42\u64cd\u4f5c\u7cfb\u7edf\u4fdd\u7559\u8db3\u591f\u7684\u5185\u5b58\u4f5c\u4e3a page cache\uff0cjvm \u4f7f\u7528\u7684\u5185\u5b58\u8d8a\u5c11\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53ef\u7528\u7684 page cache \u7a7a\u95f4\u8d8a\u5927\u3002</p> <p>\u786e\u4fdd\u5806\u5185\u5b58\u6700\u5c0f\u503c\uff08 Xms \uff09\u4e0e\u6700\u5927\u503c\uff08 Xmx \uff09\u7684\u5927\u5c0f\u662f\u76f8\u540c\u7684\uff0c\u9632\u6b62\u7a0b\u5e8f\u5728\u8fd0\u884c\u65f6\u6539\u53d8\u5806\u5185\u5b58\u5927\u5c0f\uff0c \u8fd9\u662f\u4e00\u4e2a\u5f88\u8017\u7cfb\u7edf\u8d44\u6e90\u7684\u8fc7\u7a0b\u3002</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/","title":"Broker \u53c2\u6570\u914d\u7f6e","text":""},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#broker-id-and-rack","title":"broker id and rack","text":"<pre><code># integer \u7c7b\u578b\uff0c\u9ed8\u8ba4 -1\n# \u624b\u52a8\u8bbe\u7f6e\u5e94\u8be5\u4ece 0 \u5f00\u59cb\uff0c\u6bcf\u4e2a broker \u4f9d\u6b21 +1\uff0c\u624b\u52a8\u8bbe\u7f6e\u7684\u503c\u4e0d\u80fd\u8d85\u8fc7 reserved.broker.max.id\nbroker.id=0\n\n# \u5982\u679c\u914d\u7f6e\u6587\u4ef6\u4e2d\u6ca1\u6709\u6307\u5b9a broker.id\uff0cbroker \u4f1a\u81ea\u52a8\u751f\u6210\u4e00\u4e2a broker.id\uff0c\u9ed8\u8ba4\u4ece reserved.broker.max.id+1 \u5f00\u59cb\nreserved.broker.max.id=1000\n\n# string \u7c7b\u578b\uff0c\u9ed8\u8ba4 null\n# topic partition \u7684 replica \u5206\u5e03\u5728\u4e0d\u540c\u7684 broker \u4e0a\uff0c\u4f46\u8fd9\u4e9b broker \u53ef\u80fd\u5728\u540c\u4e00\u4e2a\u673a\u67b6/\u673a\u623f/\u533a\u57df\u5185\uff0c\n# \u5982\u679c\u60f3\u8ba9 replica \u5728\u4e0d\u540c\u673a\u67b6/\u673a\u623f/\u533a\u57df\u5185\u5206\u5e03\uff0c\u53ef\u4ee5\u5c06\u4e0d\u540c\u673a\u67b6/\u673a\u623f/\u533a\u57df\u7684 broker \u914d\u7f6e\u4e0d\u540c\u7684 broker.rack\uff0c\n# \u914d\u7f6e\u540e\uff0ctopic partition \u7684 replica \u4f1a\u5206\u5e03\u5728\u4e0d\u540c\u7684 broker.rack\nbroker.rack=null\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#io","title":"\u7f51\u7edc\u548c io \u64cd\u4f5c\u7ebf\u7a0b\u914d\u7f6e","text":"<pre><code>num.network.threads=9\n</code></pre> <p>broker \u7528\u4e8e\u63a5\u6536\u6765\u81ea\u7f51\u7edc\u7684\u8bf7\u6c42\u5e76\u5411\u7f51\u7edc\u53d1\u9001\u54cd\u5e94\u7684\u7ebf\u7a0b\u6570\uff0c\u5bf9\u5e94 kafka \u7684 Processor \u7ebf\u7a0b\u6570\uff0c\u5904\u7406\u5df2\u8fde\u63a5 socket \u6570\u636e\u8bfb\u5199</p> <p>\u53ef\u4ee5\u52a8\u6001\u8c03\u6574\uff0c\u6bcf\u6b21\u52a8\u6001\u8c03\u6574\u8303\u56f4\u4e3a [currentSize / 2, currentSize * 2]</p> <pre><code>num.io.threads=16\n</code></pre> <p>broker \u5904\u7406\u8bf7\u6c42\u7684\u7ebf\u7a0b\u6570\uff0c\u5bf9\u5e94 kafka \u7684 Handler \u7ebf\u7a0b\u6570\uff0c\u8fdb\u884c\u5b9e\u9645\u7684 kafka \u52a8\u4f5c</p> <p>\u53ef\u4ee5\u52a8\u6001\u8c03\u6574\uff0c\u6bcf\u6b21\u52a8\u6001\u8c03\u6574\u8303\u56f4\u4e3a [currentSize / 2, currentSize * 2]</p> <pre><code>socket.receive.buffer.bytes=102400\n</code></pre> <p>broker server socket \u7684 SO_RCVBUF \u5927\u5c0f\uff0c\u9ed8\u8ba4 100kB</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#log","title":"log \u6570\u636e\u6587\u4ef6\u5237\u76d8\u7b56\u7565","text":"<pre><code># \u6bcf\u5f53producer\u5199\u516510000\u6761\u6d88\u606f\u65f6\uff0c\u5237\u6570\u636e\u5230\u78c1\u76d8\nlog.flush.interval.messages=10000\n\n# \u6bcf\u95f4\u96941\u79d2\u949f\u65f6\u95f4\uff0c\u5237\u6570\u636e\u5230\u78c1\u76d8\nlog.flush.interval.ms=1000\n</code></pre> <p>Kafka \u5b98\u65b9\u5e76\u4e0d\u5efa\u8bae\u901a\u8fc7 Broker \u7aef\u7684 log.flush.interval.messages \u548c log.flush.interval.ms \u6765\u5f3a\u5236\u5199\u76d8\uff0c\u8ba4\u4e3a\u6570\u636e\u7684\u53ef\u9760\u6027\u5e94\u8be5\u901a\u8fc7 Replica \u6765\u4fdd\u8bc1\uff0c\u800c\u5f3a\u5236 flush \u6570\u636e\u5230\u78c1\u76d8\u4f1a\u5bf9\u6574\u4f53\u6027\u80fd\u4ea7\u751f\u5f71\u54cd</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#_1","title":"\u65e5\u5fd7\u4fdd\u7559\u7b56\u7565\u914d\u7f6e","text":"<pre><code># \u65e5\u5fd7\u4fdd\u7559\u65f6\u957f\nlog.retention.hours=72\n\n# \u5355\u4e2a partition \u7684\u65e5\u5fd7\u4fdd\u7559\u5927\u5c0f\nlog.retention.bytes\n\n# \u68c0\u67e5\u65e5\u5fd7\u662f\u5426\u9700\u8981\u6e05\u7406\u7684\u65f6\u95f4\u95f4\u9694\nlog.retention.check.interval.ms\n\n# \u4ece\u6587\u4ef6\u7cfb\u7edf\u4e2d\u5220\u9664\u6587\u4ef6\u4e4b\u524d\u7b49\u5f85\u7684\u65f6\u95f4\nfile.delete.delay.ms=60000\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#_2","title":"\u65e5\u5fd7\u6587\u4ef6","text":"<pre><code># \u6bb5\u6587\u4ef6\u5927\u5c0f\uff0c\u9ed8\u8ba4 1G\nlog.segment.bytes=1073741824\n\n# \u542f\u52a8\u65f6\u52a0\u8f7d\u6bcf\u4e2a\u6587\u4ef6\u5939\u5185 segment \u6587\u4ef6\u5bf9\u5e94\u7684\u7ebf\u7a0b\u6570\nnum.recovery.threads.per.data.dir=1\n\n# \u5373\u4f7f\u6bb5\u6587\u4ef6\u5927\u5c0f\u6ca1\u6709\u8fbe\u5230\u56de\u6eda\u7684\u5927\u5c0f\uff0c\u8d85\u8fc7\u6b64\u65f6\u95f4\u8bbe\u7f6e\uff0c\u6bb5\u6587\u4ef6\u4e5f\u4f1a\u56de\u6eda\nlog.roll.hours\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#replica","title":"replica\u590d\u5236\u914d\u7f6e","text":"<pre><code># \u8fde\u63a5\u5176\u4ed6 broker \u62c9\u53d6\u7ebf\u7a0b\u6570\nnum.replica.fetchers=1\n</code></pre> <p>\u6ce8\u610f\u8fd9\u91cc\u662f\u8fde\u63a5\u6bcf\u4e2a broker \u7684\u7ebf\u7a0b\u6570\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53 fetcher \u7ebf\u7a0b\u6570\u8bbe\u7f6e\u4e3a x \u65f6\uff0c\u5982\u679c\u96c6\u7fa4\u6709 n \u4e2a\u8282\u70b9\uff0c\u6bcf\u4e2a\u8282\u70b9\u6709 x * (n - 1) \u4e2a fetcher \u7528\u6765\u8fde\u63a5\u5176\u4ed6 n - 1 \u4e2a\u8282\u70b9</p> <p>\u53ef\u4ee5\u52a8\u6001\u8c03\u6574\uff0c\u6bcf\u6b21\u52a8\u6001\u8c03\u6574\u8303\u56f4\u4e3a [currentSize / 2, currentSize * 2]</p> <pre><code># \u62c9\u53d6\u6d88\u606f\u6700\u5c0f\u5b57\u8282\nreplica.fetch.min.bytes=1\n\n# \u62c9\u53d6\u6d88\u606f\u6700\u5927\u5b57\u8282\uff0c\u9ed8\u8ba4\u4e3a1MB\uff0c\u6839\u636e\u4e1a\u52a1\u60c5\u51b5\u8c03\u6574\nreplica.fetch.max.bytes=5242880\n\n# \u62c9\u53d6\u6d88\u606f\u7b49\u5f85\u65f6\u95f4\nreplica.fetch.wait.max.ms\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#_3","title":"\u5206\u533a\u6570\u91cf\u914d\u7f6e","text":"<pre><code>num.partitions=1\n</code></pre> <p>\u9ed8\u8ba4 partition \u6570\u91cf 1\uff0c\u5982\u679c topic \u5728\u521b\u5efa\u65f6\u6ca1\u6709\u6307\u5b9a partition \u6570\u91cf\uff0c\u9ed8\u8ba4\u4f7f\u7528\u6b64\u503c</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#replica_1","title":"replica \u6570\u914d\u7f6e","text":"<pre><code>default.replication.factor=1\n</code></pre> <p>\u9ed8\u8ba4\u7684 replica \u6570\u91cf\uff0c\u5982\u679c topic \u5728\u521b\u5efa\u65f6\u6ca1\u6709\u6307\u5b9a partition \u6570\u91cf\uff0c\u9ed8\u8ba4\u4f7f\u7528\u6b64\u503c</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#replica-lag","title":"replica lag","text":"<pre><code>replica.lag.time.max.ms=10000\nreplica.lag.max.messages=4000\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#auto-rebalance","title":"auto rebalance","text":"<pre><code># \u542f\u7528\u81ea\u52a8\u5e73\u8861 leader\nauto.leader.rebalance.enable=true\n\n# \u68c0\u67e5\u81ea\u52a8\u5e73\u8861 leader \u7684\u65f6\u95f4\u95f4\u9694\nleader.imbalance.check.interval.seconds=300\n\n# \u5141\u8bb8\u6bcf\u4e2a broker leader \u4e0d\u5e73\u8861\u7684\u6bd4\u4f8b\nleader.imbalance.per.broker.percentage=10\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#offset-retention","title":"offset retention","text":"<pre><code>offsets.retention.check.interval.ms = 600000\noffsets.retention.minutes = 1440\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#_4","title":"\u65f6\u95f4\u6233","text":"<pre><code>log.message.timestamp.type=CreateTime/LogAppendTime\n</code></pre> <p>0.10.0.0 \u7248\u672c\u540e\uff0ckafka \u6d88\u606f\u589e\u52a0\u4e86 timestamp \u5b57\u6bb5\uff0c\u8868\u793a\u6d88\u606f\u7684\u65f6\u95f4\u6233\uff0c\u6709 2 \u79cd\u7c7b\u578b\uff1a</p> <ol> <li><code>CreateTime</code>: producer \u7aef\u53d1\u9001\u6d88\u606f\u65f6\u7ed9\u6d88\u606f\u8bbe\u7f6e\u7684 timestamp \u5b57\u6bb5\uff0c\u7406\u89e3\u4e3a\u6d88\u606f\u521b\u5efa\u65f6\u95f4\u3002</li> <li><code>LogAppendTime</code>: \u4f7f\u7528 broker \u63a5\u6536\u6d88\u606f\u7684\u65f6\u95f4\u4f5c\u4e3a\u6d88\u606f\u7684 timestamp\uff08\u4f1a\u8986\u76d6\u6d88\u606f\u672c\u8eab\u643a\u5e26\u7684 timestamp \u5b57\u6bb5)\uff0c\u7406\u89e3\u4e3a\u6d88\u606f\u5199\u5165\u65f6\u95f4\u3002</li> </ol> <p>\u65f6\u95f4\u6233\u7c7b\u578b\u4e3a <code>CreateTime</code> \u65f6\uff0c\u5141\u8bb8 create time \u4e0e\u5f53\u524d\u65f6\u95f4\u6700\u5927\u7684\u65f6\u95f4\u5dee\uff1a</p> <pre><code>log.message.timestamp.difference.max.ms=9223372036854775807\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#_5","title":"\u9650\u6d41","text":"<pre><code>leader.replication.throttled.rate\n</code></pre> <p>\u8868\u793a leader \u8282\u70b9\u5bf9\u6765\u81ea\u526f\u672c\u590d\u5236\u7684\u8bfb\u6d41\u91cf\u9650\u5236\uff0c\u642d\u914d topic \u53c2\u6570 <code>leader.replication.throttled.replicas</code> \u4f7f\u7528\u3002</p> <pre><code>follower.replication.throttled.rate\n</code></pre> <p>\u8868\u793a follower \u8282\u70b9\u590d\u5236\u526f\u672c\u7684\u5199\u6d41\u91cf\u9650\u5236\uff0c\u642d\u914d topic \u53c2\u6570 <code>follower.replication.throttled.replicas</code> \u4f7f\u7528\u3002</p> <p>\u5047\u8bbe broker 1 \u4e0a leader.replication.throttled.rate \u8bbe\u7f6e\u4e3a 512KB\uff0ctopic A \u5206\u533a 0 \u5206\u5e03\u5728 broker 1 \u548c broker 2 \u4e0a\uff0cbroker 1 \u4e0a\u4e3a\u5206\u533a leader\uff0c\u8bbe\u7f6e topic A \u7ea7\u522b\u7684 leader.replication.throttled.replicas=0:1\uff0c\u5219 broker 2 \u4e0a topic A \u5206\u533a 0 \u4ece broker 1 \u4e0a\u540c\u6b65\u5206\u533a 0 \u6570\u636e\u7684\u901f\u5ea6\u88ab\u9650\u5236\u4e3a 512KB\u3002</p> <p>\u591a\u4e2a\u526f\u672c\u540c\u65f6\u8fdb\u884c\u540c\u6b65\uff0c\u90fd\u4f1a\u5360\u7528 leader \u7684\u9650\u6d41\u9608\u503c</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#_6","title":"\u793a\u4f8b","text":"<p>\u5728 broker 1 \u4e0a\u9650\u5236 topic A \u7684\u5206\u533a 0, 1, 2 \u7684 leader read \u603b\u901f\u7387\u4e3a 1024 B/s</p> <pre><code># broker 1 \u589e\u52a0 broker \u7ea7\u522b\u914d\u7f6e\nleader.replication.throttled.rate=1024\n\n# topic A \u589e\u52a0 topic \u7ea7\u522b\u914d\u7f6e\nleader.replication.throttled.replicas=0:1,1:1,2:1\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#logcleaner","title":"log.cleaner","text":"<p>compact \u6e05\u7406\u7b56\u7565\u76f8\u5173</p> <pre><code>log.cleaner.delete.retention.ms\n\nlog.cleaner.enable\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#_7","title":"\u538b\u7f29","text":"<p>broker \u7aef\u9ed8\u8ba4\u4f7f\u7528\u751f\u6210\u8005\u7684\u538b\u7f29\u7b56\u7565\uff0c\u5f53\u751f\u4ea7\u8005\u53d1\u9001\u7684\u6d88\u606f RecordBatch \u538b\u7f29\u65f6\uff0cbroker \u7aef\u4e0d\u9700\u8981\u89e3\u538b\uff0c\u76f4\u63a5\u5199\u5165</p> <pre><code># 'gzip', 'snappy', 'lz4', 'zstd'\ncompression.type=producer\n</code></pre> <p>\u4ee5\u4e0b 3 \u79cd\u60c5\u51b5\uff0cbroker \u9700\u8981\u5bf9\u751f\u4ea7\u8005\u7684\u538b\u7f29\u6d88\u606f\u89e3\u538b\u5e76\u91cd\u65b0\u538b\u7f29:</p> <ol> <li>\u5f53 broker \u7aef\u4f7f\u7528\u4e86\u548c\u751f\u4ea7\u8005\u4e0d\u540c\u7684\u538b\u7f29\u7b97\u6cd5</li> <li>broker \u7aef\u6d88\u606f\u683c\u5f0f\u4e0e\u751f\u4ea7\u8005\u4e0d\u4e00\u81f4\u65f6</li> <li>broker \u76ee\u6807\u6d88\u606f\u683c\u5f0f\u662f V0\uff0c\u9700\u8981\u4e3a\u6bcf\u6761\u6d88\u606f\u91cd\u65b0\u5206\u914d\u7edd\u5bf9 offset\uff0c\u56e0\u6b64\u4e5f\u9700\u8981\u8fdb\u884c\u89e3\u538b</li> </ol> <p>\u5f53\u6d88\u8d39\u7ec4\u4ece broker \u8bfb\u53d6\u6d88\u606f\u65f6\uff0cbroker \u4f1a\u628a\u538b\u7f29\u6d88\u606f\u76f4\u63a5\u53d1\u51fa\uff0c\u6d88\u8d39\u8005\u8bfb\u5230\u538b\u7f29\u7684\u6d88\u606f\u540e\uff0c\u53ef\u4ee5\u6839\u636e RecordBatch attributes \u5b57\u6bb5\u5f97\u77e5\u6d88\u606f\u538b\u7f29\u7b97\u6cd5\uff0c\u81ea\u884c\u89e3\u538b\u3002</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/2-broker-config/#_8","title":"\u4e8b\u52a1","text":"<p>__transaction_state \u4e3b\u9898\u914d\u7f6e\uff1a</p> <pre><code># __transaction_state \u7684 min.insync.replicas\uff0c\u9ed8\u8ba4 2 (\u4f18\u5148\u7ea7\u9ad8\u4e8e\u4e3b\u9898\u7ea7\u522b\u914d\u7f6e)\ntransaction.state.log.min.isr=2\n\n# __transaction_state \u7684\u5206\u533a\u6570\uff0c\u9ed8\u8ba4 50 (\u90e8\u7f72\u540e\u4e0d\u5e94\u8be5\u66f4\u6539)\ntransaction.state.log.num.partitions=50\n\n# __transaction_state \u7684\u526f\u672c\u6570\uff0c\u9ed8\u8ba4 3\ntransaction.state.log.replication.factor=3\n</code></pre> <p>\u5176\u4ed6\u914d\u7f6e</p> <pre><code># \u4e8b\u52a1\u8d85\u65f6\u65f6\u95f4\uff0c\u9ed8\u8ba4 15\u5206\u949f\ntransaction.max.timeout.ms=900000\n\n# transaction coordinator \u591a\u4e45\u6ca1\u6709\u6536\u5230 transaction \u72b6\u6001\u66f4\u65b0\u540e\u5c06 transaction id \u89c6\u4e3a\u8fc7\u671f\n# \u9ed8\u8ba4 7 \u5929\ntransactional.id.expiration.ms=604800000\n\n# rollback \u8d85\u65f6 transaction \u7684\u65f6\u95f4\u95f4\u9694\uff0c\u9ed8\u8ba4 10 \u79d2\ntransaction.abort.timed.out.transaction.cleanup.interval.ms=10000\n\n# remove \u8fc7\u671f transaction \u7684\u65f6\u95f4\u95f4\u9694\uff0c\u9ed8\u8ba4 1 \u5c0f\u65f6\ntransaction.remove.expired.transaction.cleanup.interval.ms=3600000\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/3-topic-config/","title":"Topic \u53c2\u6570\u914d\u7f6e","text":""},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/3-topic-config/#_1","title":"\u65f6\u95f4\u6233","text":"<pre><code>message.timestamp.type=LogAppendTime/CreateTime\n</code></pre> <p>\u5b9a\u4e49\u6d88\u606f\u7684\u65f6\u95f4\u6233\u7c7b\u578b\u4e3a <code>CreateTime</code> \u6216\u8005 <code>LogAppendTime</code></p> <pre><code>message.timestamp.difference.max.ms\n</code></pre> <p>\u5f53\u6d88\u606f\u65f6\u95f4\u6233\u7c7b\u578b\u4e3a <code>CreateTime</code> \u65f6\uff0c\u53ef\u4ee5\u63a5\u53d7\u7684\u521b\u5efa\u65f6\u95f4\u4e0e\u5f53\u524d\u65f6\u95f4\u7684\u6700\u5927\u65f6\u95f4\u5dee</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/3-topic-config/#_2","title":"\u9650\u6d41","text":"<pre><code>leader.replication.throttled.replicas\n</code></pre> <p>\u8868\u793a\u9700\u8981\u9650\u6d41\u7684 leader partition replica \u5217\u8868\u3002\u683c\u5f0f\u4e3a <code>partitionId:brokerId,partitionId:brokerId,...</code>\uff0c\u6216\u8005\u4f7f\u7528 <code>*</code> \u4ee3\u8868\u6b64 topic \u7684\u5168\u90e8\u526f\u672c\u3002\u642d\u914d broker \u53c2\u6570 <code>leader.replication.throttled.rate</code> \u4f7f\u7528</p> <pre><code>follower.replication.throttled.replicas\n</code></pre> <p>\u8868\u793a\u9700\u8981\u9650\u6d41\u7684 follower partition replica \u5217\u8868\u3002\u683c\u5f0f\u4e3a <code>partitionId:brokerId,partitionId:brokerId,...</code>\uff0c\u6216\u8005\u4f7f\u7528 <code>*</code> \u4ee3\u8868\u6b64 topic \u7684\u5168\u90e8\u526f\u672c\u3002\u642d\u914d broker \u53c2\u6570 <code>follower.replication.throttled.rate</code> \u4f7f\u7528</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/4-producer-config/","title":"\u751f\u4ea7\u8005\u53c2\u6570\u914d\u7f6e","text":"<pre><code># \u5185\u5b58\u7f13\u51b2\u5927\u5c0f\uff0c\u5355\u4f4d byte\nbuffer.memory=33554432\n</code></pre> <p>\u5728 Producer \u7aef\u7528\u6765\u5b58\u653e\u5c1a\u672a\u53d1\u9001\u51fa\u53bb\u7684 Message \u7684\u7f13\u51b2\u533a\u5927\u5c0f\uff0c\u9ed8\u8ba4 32MB\u3002\u5185\u5b58\u7f13\u51b2\u533a\u5185\u7684\u6d88\u606f\u4ee5\u4e00\u4e2a\u4e2a batch \u7684\u5f62\u5f0f\u7ec4\u7ec7\uff0c\u6bcf\u4e2a batch \u5185\u5305\u542b\u591a\u6761\u6d88\u606f\uff0cProducer \u4f1a\u628a\u591a\u4e2a batch \u6253\u5305\u6210\u4e00\u4e2a request \u53d1\u9001\u5230 kafka \u670d\u52a1\u5668\u4e0a\u3002</p> <pre><code># `0.11.0.0` \u7248\u672c\u4e4b\u540e\u5e9f\u5f03\nblock.on.buffer.full=false\n</code></pre> <p>\u5185\u5b58\u7f13\u51b2\u533a\u6ee1\u4e86\u4e4b\u540e\u53ef\u4ee5\u9009\u62e9\u963b\u585e\u53d1\u9001\u6216\u629b\u51fa\u5f02\u5e38\uff0c\u7531 <code>block.on.buffer.full</code> \u7684\u914d\u7f6e\u6765\u51b3\u5b9a\uff08<code>0.11.0.0</code> \u7248\u672c\u4e4b\u540e\u5e9f\u5f03\uff09\u3002</p> <pre><code>max.block.ms=60000\n</code></pre> <p>\u8bbe\u7f6e <code>Producer</code> \u7684 <code>send()</code>, <code>partitionsFor()</code> \u7b49\u65b9\u6cd5\u7684\u6700\u591a\u963b\u585e\u65f6\u957f\u3002</p> <ul> <li>\u5f53\u7f13\u51b2\u533a <code>buffer.memory</code> \u5199\u6ee1\u540e\uff0cProducer <code>send()</code> \u65b9\u6cd5\u6700\u591a\u963b\u585e\u65f6\u95f4\u4e0d\u8d85\u8fc7 <code>max.block.ms</code> \u8bbe\u7f6e\u7684\u503c\uff0c\u8d85\u8fc7\u540e producer \u4f1a\u629b\u51fa <code>TimeoutException</code> \u5f02\u5e38\u3002</li> <li> <p>\u5143\u6570\u636e\u62c9\u53d6\u8d85\u65f6\uff0c\u4e5f\u4f1a\u5bfc\u81f4 <code>send()</code> \u65b9\u6cd5\u8d85\u65f6\u3002</p> <p>batch.size=16384</p> </li> </ul> <p>Producer \u4f1a\u628a\u53d1\u5f80\u540c\u4e00\u4e2a topic partition \u7684\u591a\u4e2a\u6d88\u606f\u8fdb\u884c\u5408\u5e76\uff0c<code>batch.size</code> \u6307\u660e\u4e86\u5408\u5e76\u540e batch \u5927\u5c0f\u7684\u4e0a\u9650\u3002\u5982\u679c\u8fd9\u4e2a\u503c\u8bbe\u7f6e\u7684\u592a\u5c0f\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6240\u6709\u7684 Request \u90fd\u4e0d\u8fdb\u884c Batch\u3002<code>batch.size</code> \u589e\u52a0\u4f1a\u589e\u5927\u541e\u5410\u91cf\uff0c\u4f46\u662f\u540c\u65f6\u4e5f\u4f1a\u589e\u52a0\u5ef6\u8fdf\u3002</p> <pre><code>linger.ms=0\n</code></pre> <p>producer \u5408\u5e76\u7684\u6d88\u606f\u7684\u5927\u5c0f\u672a\u8fbe\u5230 <code>batch.size</code>\uff0c\u4f46\u5982\u679c\u5b58\u5728\u65f6\u95f4\u8fbe\u5230 <code>linger.ms</code>\uff0c\u4e5f\u4f1a\u8fdb\u884c\u53d1\u9001\u3002\u589e\u52a0\u6b64\u503c\u53ef\u80fd\u4f1a\u589e\u52a0\u541e\u5410\u91cf\uff0c\u4f46\u540c\u65f6\u4e5f\u4f1a\u589e\u52a0\u5ef6\u8fdf\u3002</p> <pre><code># \u6700\u5927\u8bf7\u6c42\u5927\u5c0f\nmax.request.size\n</code></pre> <p>\u51b3\u5b9a\u4e86\u6bcf\u6b21\u53d1\u9001\u7ed9 Kafka \u670d\u52a1\u5668\u8bf7\u6c42\u7684\u6700\u5927\u5927\u5c0f\uff0c\u540c\u65f6\u4e5f\u9650\u5236\u4e86\u5355\u6761\u6d88\u606f\u7684\u6700\u5927\u5927\u5c0f</p> <pre><code># \u8bf7\u6c42-\u54cd\u5e94\u8d85\u65f6\u65f6\u95f4\uff0c\u5e94\u8be5\u5927\u4e8e\u670d\u52a1\u7aef\u7684 replica.lag.time.max.ms\nrequest.timeout.ms=30000\n\n# \u53d1\u9001\u5931\u8d25\u91cd\u8bd5\u6b21\u6570\nretries=2147483647\n# \u6bcf\u6b21\u91cd\u8bd5\u95f4\u9694\u65f6\u95f4\nretries.backoff.ms=100\n\n# \u538b\u7f29\u7c7b\u578b\ncompression.type=none\n</code></pre> <p>\u9ed8\u8ba4\u53d1\u9001\u4e0d\u8fdb\u884c\u538b\u7f29\uff0c\u63a8\u8350\u914d\u7f6e\u4e00\u79cd\u9002\u5408\u7684\u538b\u7f29\u7b97\u6cd5\uff0c\u53ef\u4ee5\u5927\u5e45\u5ea6\u7684\u51cf\u7f13\u7f51\u7edc\u538b\u529b\u548cBroker\u7684\u5b58\u50a8\u538b\u529b\u3002</p> <pre><code>acks=1\n</code></pre> <p>\u8fd9\u4e2a\u914d\u7f6e\u53ef\u4ee5\u8bbe\u5b9a\u53d1\u9001\u6d88\u606f\u540e\u662f\u5426\u9700\u8981 Broker \u7aef\u8fd4\u56de\u786e\u8ba4:</p> <ul> <li>0\uff1a\u8868\u793a producer \u8bf7\u6c42\u53d1\u51fa\u540e\u7acb\u5373\u8fd4\u56de\uff0c\u4e0d\u9700\u8981\u7b49\u5f85 leader \u7684\u4efb\u4f55\u786e\u8ba4</li> <li>1\uff1a\u8868\u793a producer \u53d1\u51fa\u8bf7\u6c42\u540e\uff0cleader \u9700\u8981\u5c06 producer \u8bf7\u6c42\u6d88\u606f\u5199\u5165\u540e\u5411 producer \u8fd4\u56de\u6210\u529f\u54cd\u5e94\uff0c\u4e4b\u540e producer \u8bf7\u6c42\u624d\u786e\u8ba4\u6210\u529f\u5e76\u8fd4\u56de</li> <li>-1/all\uff1a\u8868\u793a producer \u53d1\u51fa\u8bf7\u6c42\u540e\uff0cleader \u9700\u8981\u5c06 producer \u8bf7\u6c42\u6d88\u606f\u5199\u5165\u5e76\u7b49\u5f85\u6240\u6709 ISR \u526f\u672c\u540c\u6b65\u540e\uff0c\u5411 producer \u8fd4\u56de\u6210\u529f\u54cd\u5e94\uff0c\u4e4b\u540e producer \u8bf7\u6c42\u624d\u786e\u8ba4\u6210\u529f\u5e76\u8fd4\u56de\u3002\u5f53 ISR \u526f\u672c\u5c11\u4e8e <code>min.insync.replicas</code> \u8bbe\u7f6e\u7684\u503c\u65f6\uff0cproducer \u5728\u6b64\u60c5\u51b5\u4f1a\u62a5 <code>NotEnoughReplicas</code> \u5f02\u5e38\u3002</li> </ul> <p>\u4ece\u4e0a\u5230\u4e0b\u7684\u8bbe\u7f6e\uff0c\u53ef\u9760\u6027\u4f9d\u6b21\u589e\u5f3a\uff0c\u541e\u5410\u91cf\u4f9d\u6b21\u964d\u4f4e\uff0c\u5ef6\u8fdf\u4f9d\u6b21\u589e\u52a0\u3002</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/4-producer-config/#_2","title":"\u751f\u4ea7\u8005\u4e0d\u4e22\u5931\u6570\u636e\u4fdd\u8bc1","text":"<pre><code>block.on.buffer.full = true\n</code></pre> <p>\u751f\u4ea7\u8005\u6d88\u606f\u5728\u5b9e\u9645\u53d1\u9001\u4e4b\u524d\u662f\u4fdd\u7559\u5728 buffer \u4e2d\uff0cbuffer \u6ee1\u4e4b\u540e\u751f\u4ea7\u7b49\u5f85\uff0c\u800c\u4e0d\u662f\u629b\u51fa\u5f02\u5e38</p> <pre><code>acks=all\n</code></pre> <p>\u6240\u6709 follower \u90fd\u54cd\u5e94\u540e\u624d\u8ba4\u4e3a\u6d88\u606f\u63d0\u4ea4\u6210\u529f\uff08\u9700\u8981\u6ce8\u610f broker \u7684 <code>min.insync.replicas</code> \u53c2\u6570\uff09</p> <pre><code>retries=Integer.MAX_VALUE\n</code></pre> <p>\u53d1\u9001\u5931\u8d25\u540e\u6301\u7eed\u91cd\u8bd5\uff08\u5355\u72ec\u8bbe\u7f6e\u8fd9\u4e2a\u53ef\u80fd\u4f1a\u9020\u6210\u6d88\u606f\u91cd\u590d\u53d1\u9001\uff09</p> <pre><code>max.in.flight.requests.per.connection=1\n</code></pre> <p>\u5355\u4e2a\u7ebf\u7a0b\u5728\u5355\u4e2a\u8fde\u63a5\u4e0a\u80fd\u591f\u53d1\u9001\u7684\u672a\u54cd\u5e94\u8bf7\u6c42\u4e2a\u6570\uff0c\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u4e3a 1 \u53ef\u4ee5\u907f\u514d\u6d88\u606f\u4e71\u5e8f\uff0c\u540c\u65f6\u53ef\u4ee5\u4fdd\u8bc1\u5728 retry \u662f\u4e0d\u4f1a\u91cd\u590d\u53d1\u9001\u6d88\u606f\uff0c\u4f46\u662f\u4f1a\u964d\u4f4e producer io \u7ebf\u7a0b\u7684\u541e\u5410\u91cf</p> <pre><code>unclean.leader.election.enable=false\n</code></pre> <p>\u5173\u95ed unclean leader \u9009\u4e3e\uff0c\u5373\u4e0d\u5141\u8bb8\u975e ISR \u4e2d\u7684\u526f\u672c\u88ab\u9009\u4e3e\u4e3a leader</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/4-producer-config/#_3","title":"\u5e42\u7b49\u6027","text":"<p>\u5f00\u542f\u5e42\u7b49\u5199\u914d\u7f6e\uff1a</p> <pre><code>enable.idempotence\n</code></pre> <p>\u793a\u4f8b\uff1a</p> <pre><code>Properties props = new Properties();\nprops.put(\"enable.idempotence\", \"true\");\nprops.put(\"acks\", \"all\");  // \u5f53 enable.idempotence \u4e3a true\uff0c\u8fd9\u91cc\u9ed8\u8ba4\u4e3a all\nprops.put(\"bootstrap.servers\", \"localhost:9092\");\nprops.put(\"key.serializer\", \"org.apache.kafka.common.serialization.StringSerializer\");\nprops.put(\"value.serializer\", \"org.apache.kafka.common.serialization.StringSerializer\");\n\nKafkaProducer producer = new KafkaProducer(props);\n</code></pre> <p>kafka \u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e <code>ack</code>, <code>retries</code> \u7b49\u53c2\u6570\u4fdd\u8bc1\u6d88\u606f\u4e0d\u4e22\u5931\uff0c\u4f46\u662f\u65e0\u6cd5\u6d88\u606f\u4e0d\u91cd\u590d\uff08\u5373 at least once\uff09\u3002</p> <p>\u5e42\u7b49\u6027\u89e3\u51b3\u6d88\u606f\u91cd\u590d\u7684\u95ee\u9898\uff0c\u5373\u591a\u6b21\u53d1\u9001\u540c\u4e00\u6761\u6d88\u606f\u5230 server \u7aef\uff0cserver \u53ea\u4f1a\u8bb0\u5f55\u4e00\u6b21\uff0c\u4e4b\u540e\u91cd\u590d\u53d1\u9001\u7684\u6d88\u606f\u4f1a\u88ab\u4e22\u5f03\u3002</p> <p>\u4e3a\u4e86\u5224\u65ad\u6d88\u606f\u662f\u5426\u91cd\u590d\uff0cKafka \u4f7f\u7528 <code>producer_id</code> + <code>sequence_number</code> \u6807\u8bb0\u6bcf\u6761\u6d88\u606f\uff0c\u7531 topic partiton \u6240\u5728 leader \u8fdb\u884c\u5224\u65ad\u5e76\u53bb\u91cd\u3002</p> <p>\u6bcf\u4e2a producer \u5728\u521d\u59cb\u5316\u65f6\uff0c\u4f1a\u5411 server \u7aef\u7533\u8bf7\u4e00\u4e2a\u552f\u4e00\u7684 <code>producer_id</code>\u3002\u4e4b\u540e\u53d1\u9001\u7684\u6bcf\u6761\u6d88\u606f\uff0c\u90fd\u4f1a\u5173\u8054\u4e00\u4e2a\u4ece 0 \u5f00\u59cb\u9012\u589e\u7684 <code>sequence_number</code>\uff0c\u6bcf\u4e2a topic partition \u90fd\u4f1a\u7ef4\u62a4\u4e00\u4e2a\u5355\u72ec\u7684 <code>sequence_number</code>\u3002</p> <p>\u56e0\u4e3a\u6bcf\u6b21 producer \u521d\u59cb\u5316\u90fd\u4f1a\u7533\u8bf7\u65b0\u7684 <code>producer_id</code>\uff0c\u4e14 <code>sequence_number</code> \u662f\u5206\u533a\u7ef4\u5ea6\u7684\uff0c\u6240\u4ee5\u53ea\u80fd\u4fdd\u8bc1\u5355\u4e2a\u4f1a\u8bdd\uff0c\u5355\u4e2a partition \u7684\u5e42\u7b49\u6027\uff0c\u91cd\u590d\u53d1\u9001\u6570\u636e\u65f6 exactly once</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/4-producer-config/#_4","title":"\u4e8b\u52a1\u6027","text":"<p>\u751f\u4ea7\u8005\u4e8b\u52a1 id</p> <pre><code>transactional.id\n</code></pre> <p>\u8bbe\u7f6e\u4e8b\u52a1 id \u540e\uff0c<code>enable.idempotence</code> \u9ed8\u8ba4\u5f00\u542f</p> <p>kafka \u5bf9\u65e5\u5fd7\u6587\u4ef6\u683c\u5f0f\u8fdb\u884c\u6269\u5c55\uff0c\u65e5\u5fd7\u4e2d\u5206\u4e3a \u666e\u901a\u6d88\u606f \u548c \u63a7\u5236\u6d88\u606f(control batch)\uff0c\u63a7\u5236\u6d88\u606f\u7528\u6765\u6807\u8bb0\u4e8b\u52a1\u88ab\u6210\u529f\u63d0\u4ea4\u8fd8\u662f\u88ab\u7ec8\u6b62\u3002</p> <p>kafka \u4e8b\u52a1\u7279\u6027\u4e3b\u8981\u7528\u4e8e 2 \u79cd\u573a\u666f\uff1a</p> <ol> <li>\u5c06\u591a\u6761\u6d88\u606f\u7684\u53d1\u9001\u52a8\u4f5c\u5c01\u88c5\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\uff0c\u5f62\u6210\u539f\u5b50\u64cd\u4f5c\uff0c\u591a\u6761\u6d88\u606f\u8981\u4e48\u90fd\u53d1\u9001\u6210\u529f\uff0c\u8981\u4e48\u90fd\u53d1\u9001\u5931\u8d25\u3002</li> <li>consume-transform-produce loop\uff0c\u5c06 \u6d88\u8d39\u6d88\u606f-\u5904\u7406\u6d88\u606f-\u53d1\u9001\u6d88\u606f \u5c01\u88c5\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\uff0c\u5f62\u6210\u539f\u5b50\u64cd\u4f5c\u3002\u5e38\u89c1\u4e8e\u6d41\u5f0f\u5904\u7406\u5e94\u7528\uff0c\u4ece\u4e00\u4e2a\u4e0a\u6e38\u63a5\u6536\u6d88\u606f\uff0c\u7ecf\u8fc7\u5904\u7406\u540e\u53d1\u9001\u7ed9\u4e0b\u6e38\u3002</li> </ol> <p>kafka \u4e8b\u52a1\u7684\u5b9e\u73b0\u539f\u7406\u662f\u628a\u5168\u90e8\u6d88\u606f\u90fd\u8ffd\u52a0\u5230\u5206\u533a\u65e5\u5fd7\u4e2d\uff0c\u5e76\u5c06\u672a\u5b8c\u6210\u4e8b\u52a1\u7684\u6d88\u606f\u6807\u8bb0\u4e3a\u672a\u63d0\u4ea4\u3002\u4e00\u65e6\u4e8b\u52a1\u63d0\u4ea4\uff0c\u8fd9\u4e9b\u6807\u8bb0\u5c31\u4f1a\u88ab\u6539\u4e3a\u5df2\u63d0\u4ea4\u3002</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/4-producer-config/#_5","title":"\u76f8\u5173\u914d\u7f6e","text":"<pre><code># \u4e8b\u52a1\u8d85\u65f6\u65f6\u95f4\uff0c\u9ed8\u8ba4 1 \u5206\u949f\n# transaction coordinator \u5728\u4e3b\u52a8\u7ec8\u6b62\u6b63\u5728\u8fdb\u884c\u7684\u4e8b\u52a1\u524d\uff0c\u7b49\u5f85\u6765\u81ea\u751f\u4ea7\u8005\u7684\u4e8b\u52a1\u72b6\u6001\u66f4\u65b0\u7684\u6700\u957f\u65f6\u95f4\n# \u4e0d\u80fd\u5927\u4e8e\u670d\u52a1\u7aef\u7684 transaction.max.timeout.ms \u8bbe\u7f6e\ntransaction.timeout.ms=60000\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/4-producer-config/#1","title":"\u573a\u666f 1","text":"<p>\u793a\u4f8b\u4ee3\u7801\uff1a</p> <pre><code>Properties props = new Properties();\nprops.put(\"key.serializer\", \"org.apache.kafka.common.serialization.StringSerializer\");\nprops.put(\"value.serializer\", \"org.apache.kafka.common.serialization.StringSerializer\");\nprops.put(\"client.id\", \"ProducerTranscationnalExample\");\nprops.put(\"bootstrap.servers\", \"localhost:9092\");\nprops.put(\"transactional.id\", \"test-transactional\");\nprops.put(\"acks\", \"all\");\nKafkaProducer producer = new KafkaProducer(props);\n\n\n// \u83b7\u53d6 PID\n// \u589e\u52a0 PID \u7684 epoch\n// \u56de\u6eda\u8fd9\u4e2a transactionId \u4e4b\u524d\u7684\u5b9e\u4f8b\u7559\u4e0b\u7684\u672a\u5b8c\u6210\u7684\u4e8b\u52a1\nproducer.initTransactions();\n\ntry {\n    // \u5f00\u59cb\u4e00\u4e2a\u4e8b\u52a1\n    // \u53ea\u4f1a\u8bb0\u5f55\u5728 producer \u672c\u5730\u72b6\u6001\uff0ctransaction coordinator \u4e0d\u4f1a\u611f\u77e5\u8fd9\u4e2a\u64cd\u4f5c\n    producer.beginTransaction();\n\n    producer.send(new ProducerRecord(topic, \"0\", \"msg test\"));\n    producer.send(new ProducerRecord(topic, \"1\", \"msg test\"));\n    producer.send(new ProducerRecord(topic, \"2\", \"msg test\"));\n\n    producer.commitTransaction();\n\n} catch (ProducerFencedException e1) {\n    // \u5df2\u7ecf\u6709\u53e6\u4e00\u4e2a\u6d3b\u8dc3\u7684 producer \u5728\u662f\u54df\u54e6\u90a3\u4e2a\u76f8\u540c\u7684 transactionId \u4e86\n    e1.printStackTrace();\n    producer.close();\n} catch (KafkaException e2) {\n    e2.printStackTrace();\n    producer.abortTransaction();\n}\nproducer.close();\n</code></pre> <ul> <li>\u539f\u5b50\u6027\uff1a\u4e8b\u52a1\u4fdd\u8bc1\u591a\u4e2a\u5199\u64cd\u4f5c\u8981\u4e48\u5168\u90e8\u6210\u529f\uff0c\u8981\u4e48\u5168\u90e8\u5931\u8d25</li> <li>\u50f5\u6b7b\u8fdb\u7a0b\uff1a\u5f00\u542f\u4e8b\u52a1\u7684 producer \u4f1a\u5411 Transaction \u7533\u8bf7\u4e00\u4e2a producer id\uff0ctransaction id \u4e0e producer id \u4e00\u4e00\u5bf9\u5e94\uff0c\u6bcf\u4e2a producer id \u5bf9\u5e94\u4e00\u4e2a epoch\uff0c\u5f53\u65b0\u7684 producer \u4f7f\u7528\u76f8\u540c\u7684 transaction id \u5f00\u542f\u4e8b\u52a1\u540e\uff0c\u4f1a\u83b7\u5f97\u76f8\u540c\u7684 producer id \u548c\u66f4\u9ad8\u7684 epoch\uff0c\u6b64\u65f6\u670d\u52a1\u7aef\u53ef\u4ee5\u6839\u636e epoch \u533a\u5206\u65b0\u65e7 producer\uff0c\u65e7\u7684 producer \u5c06\u4e0d\u80fd\u5199\u5165\u6d88\u606f\u3002</li> </ul>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/4-producer-config/#2","title":"\u573a\u666f 2","text":"<pre><code>Properties producerProps = new Properties();\nproducerProps.put(\"bootstrap.servers\", \"localhost:9092\");\nproducerProps.put(\"key.serializer\", \"org.apache.kafka.common.serialization.StringSerializer\");\nproducerProps.put(\"value.serializer\", \"org.apache.kafka.common.serialization.StringSerializer\");\n\nproducerProps.put(\"transactional.id\", \"test-transactional\");\nproducerProps.put(\"acks\", \"all\");\nKafkaProducer producer = new KafkaProducer(producerProps);\n\nProperties consumerProps = new Properties();\nconsumerProps.put(\"bootstrap.servers\", \"localhost:9092\");\nconsumerProps.put(\"key.serializer\", \"org.apache.kafka.common.serialization.StringSerializer\");\nconsumerProps.put(\"value.serializer\", \"org.apache.kafka.common.serialization.StringSerializer\");\n\nconsumerProps.put(\"group.id\", groupId);\nconsumerProps.put(\"enable.auto.commit\", \"false\");\nconsumerProps.put(\"isolation.level\", \"read_committed\");\nKafkaConsumer consumer = new KafkaConsumer(consumerProps);\n\nconsumer.subscribe(Collections.singleton(\"source_topic\"));\n\n\nproducer.initTransactions();\n\ntry {\n    ConsumerRecords records = consumer.poll();\n    if (!records.isEmpty()) {\n\n        producer.beginTransaction();\n\n        // \u5904\u7406\u6d88\u606f\n        List&lt;ProducerRecord&gt; outputRecords = processRecords(records)\n        for (ProducerRecord ouputRecord : outputRecords) {\n            producer.send(outputRecord)\n        }\n\n        // \u7531 producer \u63d0\u4ea4 offset\n        producer.sendOffsetsToTransaction();\n\n        // \u5b8c\u6210\u4e00\u4e2a\u6279\u6b21\u7684 \u6d88\u8d39-\u5904\u7406-\u751f\u4ea7\uff0c\u63d0\u4ea4\u4e8b\u52a1\n        producer.commitTransaction();\n    }\n} catch (ProducerFencedException e1) {\n    e1.printStackTrace();\n    producer.close();\n} catch (KafkaException e2) {\n    e2.printStackTrace();\n    producer.abortTransaction();\n}\nproducer.close();\n</code></pre> <ul> <li>https://cwiki.apache.org/confluence/display/KAFKA/KIP-98+-+Exactly+Once+Delivery+and+Transactional+Messaging</li> </ul>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/5-consumer-config/","title":"\u6d88\u8d39\u8005\u53c2\u6570\u914d\u7f6e","text":""},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/5-consumer-config/#consumer","title":"consumer \u4ec0\u4e48\u65f6\u5019\u88ab\u8ba4\u4e3a\u4e0b\u7ebf","text":""},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/5-consumer-config/#_2","title":"\u5fc3\u8df3","text":"<pre><code>session.timeout.ms=10000\n</code></pre> <p>\u4f1a\u8bdd\u8d85\u65f6\u65f6\u95f4\uff0c\u5982\u679c\u53d1\u9001\u5fc3\u8df3\u65f6\u95f4\u8d85\u8fc7\u8fd9\u4e2a\u65f6\u95f4\uff0cbroker \u5c31\u4f1a\u8ba4\u4e3a\u6d88\u8d39\u8005\u6389\u7ebf</p> <p>\u5fc5\u987b\u5728 broker \u53c2\u6570 <code>group.min.session.timeout.ms</code> \u4e0e <code>group.max.session.timeout.ms</code> \u4e4b\u95f4</p> <pre><code>heartbeat.interval.ms=3000\n</code></pre> <p>\u53d1\u9001\u5fc3\u8df3\u95f4\u9694\u65f6\u95f4\uff0c\u63a8\u8350\u4e0d\u8981\u9ad8\u4e8e <code>session.timeout.ms</code> \u7684 1/3</p> <pre><code># 9 minutes\nconnections.max.idle.ms=540000\n</code></pre> <p>\u8fde\u63a5\u7a7a\u95f2\u65f6\u95f4\u8d85\u8fc7\u6b64\u914d\u7f6e\u540e\u5173\u95ed</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/5-consumer-config/#poll","title":"poll","text":"<pre><code>max.poll.interval.ms=300000\n</code></pre> <p><code>poll()</code> \u8c03\u7528\u7684\u6700\u5927\u65f6\u95f4\u95f4\u9694\uff0c\u5982\u679c\u8ddd\u79bb\u4e0a\u4e00\u6b21 <code>poll()</code> \u8c03\u7528\u7684\u65f6\u95f4\u8d85\u8fc7 <code>max.poll.interval.ms</code>\uff0c\u6d88\u8d39\u8005\u4f1a\u88ab\u8ba4\u4e3a\u5931\u8d25</p> <p>\u4e3a\u4ec0\u4e48\u6709\u5fc3\u8df3\u540e\u8fd8\u9700\u8981\u8bbe\u7f6e <code>max.poll.interval.ms</code> \u8d85\u65f6\u673a\u5236\uff0c\u56e0\u4e3a\u5373\u4f7f\u6d88\u8d39\u8005\u6709\u5fc3\u8df3\uff0c\u4e5f\u53ea\u80fd\u8bc1\u660e\u6d88\u8d39\u8005\u662f\u5b58\u6d3b\u72b6\u6001\uff0c\u4f46\u662f\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u6d88\u8d39\u8005\u6b63\u5e38\uff0c\u6bd4\u5982\u6d88\u8d39\u8005\u56e0\u4e3a\u6b7b\u9501\u5bfc\u81f4\u6c38\u8fdc\u65e0\u6cd5\u8c03\u7528 <code>poll()</code></p> <pre><code>max.poll.records=500\n</code></pre> <p>\u5355\u6b21 <code>poll()</code> \u8c03\u7528\u53ef\u4ee5\u62c9\u53d6\u7684\u6700\u591a\u6d88\u606f\uff0c\u589e\u52a0\u8be5\u503c\u53ef\u80fd\u4f1a\u5bfc\u81f4 <code>poll()</code> \u8c03\u7528\u95f4\u9694\u589e\u52a0</p> <p>\u6b64\u53c2\u6570\u5e76\u4e0d\u5f71\u54cd\u6d88\u8d39\u8005\u5e95\u5c42 fetch \u8bf7\u6c42\u8c03\u7528\u7684\u884c\u4e3a\uff0c\u6d88\u8d39\u8005\u4f1a\u7f13\u5b58 fetch \u8bf7\u6c42\u62c9\u53d6\u7684\u6d88\u606f\uff0cpoll \u8c03\u7528\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6\u6d88\u606f</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/5-consumer-config/#_3","title":"\u6279\u6b21","text":"<pre><code>fetch.min.bytes=1\n</code></pre> <p>fetch \u8bf7\u6c42\u8981\u6c42\u670d\u52a1\u7aef\u8fd4\u56de\u54cd\u5e94\u6700\u5c11\u5e94\u8fbe\u5230\u7684\u6570\u636e\u91cf\uff0c\u9ed8\u8ba4\u4e3a 1\uff0c\u589e\u52a0\u8be5\u503c\u53ef\u80fd\u63d0\u9ad8\u670d\u52a1\u7aef\u7684\u541e\u5410\u91cf\uff0c\u540c\u65f6\u589e\u52a0\u5ef6\u8fdf</p> <pre><code>max.partition.fetch.bytes\n</code></pre> <p>fetch \u8bf7\u6c42\u8981\u6c42\u670d\u52a1\u7aef\u5bf9\u6bcf\u4e2a partition \u8fd4\u56de\u54cd\u5e94\u6700\u591a\u8fbe\u5230\u7684\u6570\u636e\u91cf\uff08\u5373\u4f7f\u8d85\u8fc7\u4e5f\u4f1a\u8fd4\u56de\uff0c\u4e0d\u662f\u786c\u6027\u7684\u56fa\u5b9a\u4e0a\u9650\uff09</p> <pre><code>fetch.max.bytes\n</code></pre> <p>fetch \u8bf7\u6c42\u8981\u6c42\u670d\u52a1\u7aef\u8fd4\u56de\u54cd\u5e94\u6700\u591a\u8fbe\u5230\u7684\u6570\u636e\u91cf\uff08\u5373\u4f7f\u8d85\u8fc7\u4e5f\u4f1a\u8fd4\u56de\uff0c\u4e0d\u662f\u786c\u6027\u7684\u56fa\u5b9a\u4e0a\u9650\uff09</p> <pre><code>fetch.max.wait.ms=500\n</code></pre> <p>fetch \u8bf7\u6c42\u8981\u6c42\u670d\u52a1\u7aef\u5728\u8fd4\u56de\u524d\u6700\u957f\u963b\u585e\u65f6\u95f4\uff0c\u5982\u679c\u5728\u8fd9\u4e2a\u65f6\u95f4\u5230\u4e86\u4ecd\u7136\u6ca1\u6709\u8fbe\u5230 <code>fetch.min.bytes</code> \u8981\u6c42\u7684\u6570\u636e\u91cf\uff0c\u4ecd\u7136\u8fd4\u56de\u54cd\u5e94</p> <pre><code>request.timeout.ms\n</code></pre> <p>\u5ba2\u6237\u7aef\u8bf7\u6c42\u7684\u8d85\u65f6\u65f6\u95f4</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/5-consumer-config/#_4","title":"\u5143\u6570\u636e","text":"<pre><code># 5 minutes\nmetadata.max.age.ms=300000\n</code></pre> <p>\u5b9a\u65f6\u5237\u65b0\u5ba2\u6237\u7aef\u5143\u6570\u636e\uff0c\u5373\u4f7f\u5728\u6b64\u671f\u95f4\u6ca1\u6709\u53d1\u751f partition leader \u5207\u6362</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/5-consumer-config/#offset-commit","title":"offset commit","text":"<pre><code>enable.auto.commit\n</code></pre> <p>\u662f\u5426\u542f\u7528\u81ea\u52a8\u63d0\u4ea4</p> <pre><code>auto.commit.interval.ms\n</code></pre> <p>\u81ea\u52a8\u63d0\u4ea4\u95f4\u9694</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/5-consumer-config/#_5","title":"\u4e8b\u52a1","text":"<p>\u8bbe\u7f6e\u4e3a\u8bfb\u5df2\u63d0\u4ea4\u6d88\u606f\uff0c\u5173\u95ed\u81ea\u52a8\u63d0\u4ea4 offset</p> <pre><code>isolation.level=read_uncommitted\n\nenable.auto.commit=false\n</code></pre> <p><code>isolation.level</code> \u63a7\u5236\u5982\u4f55\u8bfb\u901a\u8fc7\u4e8b\u52a1\u5199\u7684\u6d88\u606f\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3a <code>read_committed</code>\uff0c\u5219\u53ea\u4f1a\u8bfb\u53d6\u4e8b\u52a1\u5df2\u63d0\u4ea4\u7684\u6d88\u606f\u4e0e\u975e\u4e8b\u52a1\u5199\u7684\u6d88\u606f\u3002\u5982\u679c\u8bbe\u7f6e\u4e3a <code>read_uncommitted</code>(\u9ed8\u8ba4\u503c)\uff0c\u5219\u4f1a\u8bfb\u53d6\u6240\u6709\u6d88\u606f\u3002</p> <p>\u6d88\u8d39\u8005\u4ee5 offset \u987a\u5e8f\u8bfb\u53d6\u6d88\u606f\uff0c\u5982\u679c\u8bbe\u7f6e\u4e86 <code>read_committed</code>\uff0c<code>consumer.poll()</code> \u53ea\u4f1a\u8fd4\u56de last stable offset (LSO) \u4e4b\u524d\u7684\u6d88\u606f\uff0cLSO \u662f\u5c0f\u4e8e\u7b2c\u4e00\u4e2a open transaction \u7684 offset\u3002</p> <p>\u6d88\u8d39\u8005\u8bbe\u7f6e <code>read_committed</code> \u4e4b\u540e\uff0c<code>seekToEnd</code> \u65b9\u6cd5\u4e5f\u4f1a\u8fd4\u56de LSO\u3002</p>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/6-other/","title":"\u5176\u4ed6","text":""},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/6-other/#_2","title":"\u652f\u6301\u7684\u6d88\u606f\u5927\u5c0f","text":""},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/6-other/#producer","title":"producer","text":"<pre><code>max.request.size\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/6-other/#broker","title":"broker","text":"<pre><code>message.max.bytes\n\n# replica fetcher\n# \u4e0d\u662f\u7edd\u5bf9\u7684\u6700\u5927\u503c\uff0c\u5982\u679c\u6d88\u606f\u8d85\u8fc7\u8fd9\u4e2a\u8bbe\u5b9a\uff0c\u6700\u5927\u503c\u4ecd\u7531 message.max.bytes, max.message.bytes \u51b3\u5b9a (?)\nreplica.fetch.max.bytes\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/6-other/#topic","title":"topic","text":"<pre><code>max.message.bytes\n</code></pre>"},{"location":"3-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/6-other/#consumer","title":"consumer","text":"<pre><code>fetch.message.max.bytes\n\nfetch.max.bytes\n</code></pre>"}]}